<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Sinais - MAROMBIEW BOT</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts & Font Awesome Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Estilos e Animações Personalizadas */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0a0a0a;
            color: #e5e7eb;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }

        .glass-card {
            background: rgba(17, 24, 39, 0.6);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Animação para card de análise */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .animate-shimmer {
            background: linear-gradient(to right, #1f2937 25%, #374151 50%, #1f2937 75%);
            background-size: 2000px 100%;
            animation: shimmer 2s linear infinite;
        }

        /* Animação para borda de novo sinal */
        @keyframes pulse-border-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        @keyframes pulse-border-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .pulse-call {
            animation: pulse-border-green 2s infinite;
        }
        .pulse-put {
            animation: pulse-border-red 2s infinite;
        }

        /* Animação de entrada para novos cards */
        @keyframes card-enter {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .card-enter-animation {
            animation: card-enter 0.4s ease-out forwards;
        }

        /* Animação: Feedback no Placar */
        @keyframes score-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); color: #ffffff; }
            100% { transform: scale(1); }
        }
        .score-updated {
            animation: score-pop 0.3s ease-in-out;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- CABEÇALHO -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-6">
            <h1 class="text-3xl font-bold text-white">
                <i class="fa-solid fa-robot text-teal-400"></i> MAROMBIEW <span class="text-teal-400">Signals</span>
            </h1>
            <div id="scoreboard" class="grid grid-cols-3 gap-4 w-full sm:w-auto glass-card p-3 rounded-xl">
                <div class="text-center px-2">
                    <p class="text-sm font-semibold text-green-400">WINS</p>
                    <p id="score-wins" class="text-2xl font-bold font-mono">0</p>
                </div>
                <div class="text-center px-2">
                    <p class="text-sm font-semibold text-red-400">LOSSES</p>
                    <p id="score-losses" class="text-2xl font-bold font-mono">0</p>
                </div>
                <div class="text-center px-2">
                    <p class="text-sm font-semibold text-amber-400">GALE WINS</p>
                    <p id="score-gale-wins" class="text-2xl font-bold font-mono">0</p>
                </div>
            </div>
        </header>

        <!-- GRELHA DE SINAIS -->
        <main id="signals-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Os cards serão injetados aqui pelo JavaScript -->
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const BOT_UTC_OFFSET = "-00:00";
            const signalsGrid = document.getElementById('signals-grid');
            const scoreWinsEl = document.getElementById('score-wins');
            const scoreLossesEl = document.getElementById('score-losses');
            const scoreGaleWinsEl = document.getElementById('score-gale-wins');
            let socket;

            function convertTimeToUserTimezone(timeString) {
                if (!timeString || !timeString.includes(':')) return timeString;
                try {
                    const todayStr = new Date().toISOString().slice(0, 10);
                    const fullDateTimeString = `${todayStr}T${timeString}:00${BOT_UTC_OFFSET}`;
                    const dateObj = new Date(fullDateTimeString);
                    return dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                } catch (e) { console.error("Erro ao converter hora:", e); return timeString; }
            }

            function connectWebSocket() {
                const websocketUrl = 'wss://botexnova.marombiew.com';
                console.log(`[WebSocket] Tentando conectar a ${websocketUrl}...`);
                socket = new WebSocket(websocketUrl);

                socket.onopen = () => console.log('[WebSocket] Conexão estabelecida.');
                socket.onmessage = (event) => {
                    console.log('[WebSocket] Mensagem recebida:', event.data.substring(0, 200));
                    try { const message = JSON.parse(event.data); handleWebSocketMessage(message); } 
                    catch (error) { console.error("Erro ao processar mensagem JSON:", error, "Data:", event.data); }
                };
                socket.onclose = () => {
                    console.log('[WebSocket] Conexão perdida. Tentando reconectar...');
                    createAnalysisCard({ status: 'Reconectando...', status_list: [] });
                    setTimeout(connectWebSocket, 5000);
                };
                socket.onerror = (error) => console.error("[WebSocket] Ocorreu um erro:", error);
            }

            function handleWebSocketMessage(message) {
                console.log(`[Handler] Processando mensagem do tipo: ${message.type}`);
                switch (message.type) {
                    case 'init': handleInitialState(message.data); break;
                    case 'analysis_status':
                    case 'analysis_update': createAnalysisCard(message); break;
                    case 'signal': removeAnalysisCard(); createSignalCard(message); break;
                    case 'result': updateCardForResult(message); break;
                    case 'gale': updateCardForGale(message); break;
                }
            }
            
            function updateScoreboard({ wins = 0, losses = 0, gale_wins = 0 } = {}) {
                if (scoreWinsEl && scoreWinsEl.textContent !== String(wins)) { scoreWinsEl.textContent = wins; scoreWinsEl.classList.add('score-updated'); setTimeout(() => scoreWinsEl.classList.remove('score-updated'), 300); }
                if (scoreLossesEl && scoreLossesEl.textContent !== String(losses)) { scoreLossesEl.textContent = losses; scoreLossesEl.classList.add('score-updated'); setTimeout(() => scoreLossesEl.classList.remove('score-updated'), 300); }
                if (scoreGaleWinsEl && scoreGaleWinsEl.textContent !== String(gale_wins)) { scoreGaleWinsEl.textContent = gale_wins; scoreGaleWinsEl.classList.add('score-updated'); setTimeout(() => scoreGaleWinsEl.classList.remove('score-updated'), 300); }
            }

            function renderCandle(candle) {
                if (!candle || !candle.high || !candle.low) return '<div class="h-full w-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-image"></i></div>';
                const candleColor = candle.close >= candle.open ? '#22c55e' : '#ef4444';
                const priceRange = candle.high - candle.low;
                if (priceRange <= 0) return `<svg viewBox="0 0 30 100" class="w-full h-full"><line x1="5" y1="50" x2="25" y2="50" stroke="${candleColor}" stroke-width="2"/></svg>`;
                const bodyHeight = (Math.abs(candle.open - candle.close) / priceRange) * 100;
                const bodyTop = ((candle.high - Math.max(candle.open, candle.close)) / priceRange) * 100;
                return `<svg viewBox="0 0 30 100" class="w-full h-full"><rect x="14" y="0" width="2" height="100" fill="${candleColor}" /><rect x="5" y="${bodyTop}" width="20" height="${bodyHeight}" fill="${candleColor}" /></svg>`;
            }

            function createAnalysisCard(statusInfo) {
                const cardId = 'analysis-card';
                let card = document.getElementById(cardId);
                if (!card) {
                    card = document.createElement('div');
                    card.id = cardId;
                    card.className = 'glass-card rounded-2xl p-4 flex flex-col items-center justify-center text-center h-full min-h-[280px]';
                    signalsGrid.prepend(card);
                }
                const asset = statusInfo.asset || "Mercado";
                const statusList = statusInfo.status_list || [statusInfo.status || "Aguardando..."];
                const nextEntryTime = statusInfo.next_entry_time ? convertTimeToUserTimezone(statusInfo.next_entry_time) : null;
                const listItems = statusList.map(item => `<li class="text-sm ${item.includes('Sem sinal') || item.includes('indeciso') ? 'text-gray-500' : 'text-gray-300'}">${item}</li>`).join('');
                let iconClass = "fa-solid fa-satellite-dish text-gray-400";
                if (statusList.some(s => s.includes("Analisando"))) iconClass = "fa-solid fa-magnifying-glass-chart text-sky-400 fa-beat";
                if (statusList.some(s => s.includes("indeciso"))) iconClass = "fa-solid fa-pause-circle text-amber-400";
                if (statusInfo.status === 'Reconectando...') iconClass = "fa-solid fa-tower-broadcast text-red-500 animate-ping";
                card.innerHTML = `<p class="font-bold text-xl text-white mb-2">${asset}</p><div class="text-4xl my-3 ${iconClass}"></div><div class="bg-gray-900/50 rounded-lg p-2 w-full text-left flex-grow"><ul class="space-y-1">${listItems}</ul></div>${nextEntryTime ? `<p class="text-sm text-gray-400 mt-2">Próxima entrada possível: ${nextEntryTime}</p>` : ''}`;
            }
            
            function removeAnalysisCard() {
                const card = document.getElementById('analysis-card');
                if (card) card.remove();
            }

            function buildSignalCard(signal) {
                if (!signal) return null;
                const card = document.createElement('div');
                card.id = signal.signal_id;
                card.className = 'glass-card rounded-2xl p-4 flex flex-col text-center';
                const isCall = signal.direction.toUpperCase() === 'CALL' || signal.direction.toUpperCase() === 'BUY';
                const directionColor = isCall ? 'text-green-400' : 'text-red-400';
                const directionIcon = isCall ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down';
                card.innerHTML = `<div class="flex justify-between items-center w-full mb-3"><p class="font-bold text-xl text-white">${signal.pair}</p><p class="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded-md">${signal.strategy}</p></div><div class="flex-grow grid grid-cols-2 gap-4 items-center"><div class="flex flex-col justify-center h-full"><p class="text-xs text-gray-400">HORÁRIO DA ENTRADA</p><p class="font-mono text-3xl font-bold text-white my-1">${convertTimeToUserTimezone(signal.entry_time)}</p><div class="font-semibold text-2xl ${directionColor}"><i class="fa-solid ${directionIcon} mr-1"></i>${signal.direction.toUpperCase()}</div></div><div class="w-16 h-28 mx-auto">${renderCandle(signal.candle)}</div></div><div class="result-footer w-full mt-3 h-16"></div>`;
                return card;
            }

            function createSignalCard(signal) {
                const card = buildSignalCard(signal);
                signalsGrid.prepend(card);
                card.classList.add('card-enter-animation');
                const pulseClass = (signal.direction.toUpperCase() === 'CALL' || signal.direction.toUpperCase() === 'BUY') ? 'pulse-call' : 'pulse-put';
                card.classList.add(pulseClass);
                setTimeout(() => card.classList.remove(pulseClass), 5000);
            }
            
            function updateCardForResult(result) {
                updateScoreboard(result.placar);
                const card = document.getElementById(result.signal_id);
                if (!card) return;
                const isWin = result.result === 'WIN';
                const resultColor = isWin ? 'text-green-400' : 'text-red-400';
                const resultIcon = isWin ? 'fa-solid fa-trophy' : 'fa-solid fa-shield-halved';
                const footer = card.querySelector('.result-footer');
                if (footer) {
                    footer.className = "result-footer w-full mt-3 h-16 flex items-center justify-center rounded-lg border";
                    footer.classList.add(isWin ? 'bg-green-500/10' : 'bg-red-500/10', isWin ? 'border-green-500/30' : 'border-red-500/30');
                    footer.innerHTML = `<div class="text-center"><p class="text-xs ${resultColor}">RESULTADO</p><p class="font-mono text-2xl font-bold ${resultColor} flex items-center justify-center gap-2"><i class="${resultIcon}"></i><span>${result.result}</span></p></div>`;
                }
            }

            function updateCardForGale(gale) {
                const card = document.getElementById(gale.signal_id);
                if (!card) return;
                let galeNotice = card.querySelector('.gale-notice');
                if (!galeNotice) {
                    galeNotice = document.createElement('div');
                    galeNotice.className = 'gale-notice absolute top-2 right-2 bg-amber-500 text-gray-900 text-xs font-bold px-2 py-0.5 rounded-full';
                    card.prepend(galeNotice);
                }
                galeNotice.textContent = `GALE ${gale.gale_level}`;
            }

            // ### LÓGICA DE INICIALIZAÇÃO CORRIGIDA PARA GARANTIR ORDEM E ATUALIZAÇÃO ###
            function handleInitialState(data) {
                if (!data) return;
                signalsGrid.innerHTML = ''; // Limpa a grelha antes de adicionar
                updateScoreboard(data.placar);
                if (data.signals && Array.isArray(data.signals)) {
                    // Ordena do mais antigo para o mais novo para usar prepend
                    data.signals.sort((a, b) => a.entry_time.localeCompare(b.entry_time))
                        .forEach(signal => {
                            // Constrói e adiciona CADA card no TOPO da lista
                            // O resultado final é a lista na ordem correta (mais novo no topo)
                            const card = buildSignalCard(signal);
                            if (card) {
                                signalsGrid.prepend(card);
                                if (signal.result) {
                                    updateCardForResult({ ...signal, placar: data.placar });
                                }
                                if (signal.gale_level > 0) {
                                    updateCardForGale(signal);
                                }
                            }
                        });
                }
                 createAnalysisCard({ status: 'Conectado. Aguardando...' });
            }

            connectWebSocket();
        });
    </script>
</body>
</html>
