import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  LayoutDashboard, 
  Layers, 
  Settings, 
  Terminal, 
  LogOut, 
  Wallet, 
  TrendingUp, 
  TrendingDown, 
  Activity, 
  Play, 
  Pause, 
  Save, 
  RefreshCw, 
  ArrowUp, 
  ArrowDown, 
  Check, 
  X, 
  Search,
  Zap,
  Lock,
  User
} from 'lucide-react';

// --- CONFIGURAÇÃO SUPABASE (API REST) ---
const SUPABASE_URL = 'https://ioduahwknfsktujthfyc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZHVhaHdrbmZza3R1anRoZnljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMDc0NDcsImV4cCI6MjA2Njg4MzQ0N30.96f8wZO6SvABKFMWjIiw1pSugAB4Isldj7yxLcLJRSE';

// Helper para chamadas API
const supabaseFetch = async (endpoint, options = {}) => {
  const headers = {
    'apikey': SUPABASE_ANON_KEY,
    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
    'Content-Type': 'application/json',
    ...options.headers
  };

  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
      ...options,
      headers
    });
    if (!res.ok) throw new Error(`API Error: ${res.statusText}`);
    return await res.json();
  } catch (err) {
    console.error("Supabase API Error:", err);
    return null;
  }
};

// --- Styles & Animations ---
const CustomStyles = () => (
  <style>{`
    @keyframes scanMove {
      0% { top: 0%; opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }
    .scan-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #f59e0b, transparent);
      animation: scanMove 2s linear infinite;
      opacity: 0.8;
      box-shadow: 0 0 10px #f59e0b;
    }
    .glass-card {
      background: rgba(31, 41, 55, 0.6);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(55, 65, 81, 0.5);
    }
    .pulse-text { animation: pulseText 0.5s ease-in-out; }
    @keyframes pulseText { 0% { opacity: 0.6; transform: scale(0.98); } 50% { opacity: 1; transform: scale(1.02); } 100% { opacity: 1; transform: scale(1); } }
  `}</style>
);

// --- Components ---

const Toast = ({ message, type, onClose }) => (
  <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-in slide-in-from-right fade-in duration-300 ${
    type === 'error' ? 'bg-red-500/90 text-white' : 
    type === 'success' ? 'bg-green-500/90 text-white' : 'bg-zinc-800/90 text-white border border-zinc-700'
  }`}>
    {type === 'success' ? <Check size={16} /> : type === 'error' ? <X size={16} /> : <Zap size={16} />}
    <span className="text-sm font-medium">{message}</span>
    <button onClick={onClose} className="ml-2 hover:bg-white/20 rounded-full p-1"><X size={12} /></button>
  </div>
);

const ScannerWidget = ({ botStatus }) => {
  const [data, setData] = useState({ pair: '---', price: '0.00000', rsi: '0.0' });
  const [anim, setAnim] = useState(false);
  const lastMsgRef = useRef('');

  useEffect(() => {
    // Polling para o Scanner (substitui Realtime)
    const fetchLogs = async () => {
        const logs = await supabaseFetch('logs?select=message&order=created_at.desc&limit=1');
        if (logs && logs.length > 0) {
            const msg = logs[0].message;
            if (msg !== lastMsgRef.current && msg.startsWith('ANALISE_DETALHADA::')) {
                lastMsgRef.current = msg;
                const parts = msg.split('::');
                if (parts.length >= 4) {
                    setData({
                        pair: parts[1],
                        price: parts[2].split(':')[1] || '0.00000',
                        rsi: parts[3].split(':')[1] || '0.0'
                    });
                    setAnim(true);
                    setTimeout(() => setAnim(false), 500);
                }
            }
        }
    };

    const interval = setInterval(fetchLogs, 2000); // Check a cada 2s
    fetchLogs();
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="glass-card rounded-xl p-6 relative overflow-hidden group">
      {botStatus === 'RUNNING' && <div className="scan-line top-0 left-0 z-0"></div>}
      
      <div className="relative z-10 flex justify-between items-start">
        <div>
          <div className="flex items-center gap-2 mb-2">
            <div className={`w-2 h-2 rounded-full ${botStatus === 'RUNNING' ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
            <span className="text-[10px] font-bold tracking-widest text-zinc-400 uppercase">
              {botStatus === 'RUNNING' ? 'SCANNER LIVE' : 'OFFLINE'}
            </span>
          </div>
          <div className={`text-3xl font-black text-white tracking-tight transition-all duration-300 ${anim ? 'text-amber-400 scale-105' : ''}`}>
            {data.pair}
          </div>
          <div className="flex items-center gap-3 mt-2">
            <span className="px-2 py-0.5 rounded bg-zinc-800 border border-zinc-700 text-xs text-zinc-400 font-mono">
              RSI: <span className={parseFloat(data.rsi) > 65 || parseFloat(data.rsi) < 35 ? 'text-amber-400 font-bold' : 'text-zinc-300'}>{data.rsi}</span>
            </span>
            <span className="px-2 py-0.5 rounded bg-zinc-800 border border-zinc-700 text-xs text-zinc-400 font-mono">
              M5
            </span>
          </div>
        </div>
        <div className="text-right">
          <p className="text-[10px] text-zinc-500 uppercase font-bold mb-1">PREÇO ATUAL</p>
          <p className="text-2xl font-mono text-zinc-200">{data.price}</p>
          {botStatus === 'RUNNING' && (
             <div className="flex justify-end mt-2 gap-1">
               <span className="w-1 h-3 bg-amber-500/20 rounded-full animate-pulse"></span>
               <span className="w-1 h-5 bg-amber-500/40 rounded-full animate-pulse delay-75"></span>
               <span className="w-1 h-2 bg-amber-500/60 rounded-full animate-pulse delay-100"></span>
               <span className="w-1 h-4 bg-amber-500 rounded-full animate-pulse delay-150"></span>
             </div>
          )}
        </div>
      </div>
    </div>
  );
};

const CountdownTimer = () => {
  const [seconds, setSeconds] = useState(60 - new Date().getSeconds());
  useEffect(() => {
    const t = setInterval(() => setSeconds(60 - new Date().getSeconds()), 1000);
    return () => clearInterval(t);
  }, []);

  return (
    <div className="flex flex-col items-center justify-center bg-zinc-800/50 rounded-lg p-2 border border-zinc-700/50">
      <span className="text-[9px] text-zinc-500 uppercase font-bold">Vela M1</span>
      <span className="text-lg font-mono font-bold text-amber-400">{String(seconds).padStart(2, '0')}s</span>
    </div>
  );
};

// --- View Components ---

const LoginView = ({ onLogin }) => {
  const [loading, setLoading] = useState(false);
  const [email, setEmail] = useState('');
  const [pass, setPass] = useState('');
  const [error, setError] = useState('');

  const handleDemoLogin = () => {
    onLogin({ id: 'demo-user', email: 'demo@marombiew.com', role: 'authenticated' });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    
    try {
        // Chamada direta Auth API
        const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
            method: 'POST',
            headers: { 
              'apikey': SUPABASE_ANON_KEY, 
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ email, password: pass })
        });
        const data = await res.json();
        
        if (!res.ok) throw new Error(data.error_description || data.msg || 'Credenciais inválidas ou erro no servidor');
        
        onLogin(data.user);
    } catch (err) {
        setError(err.message);
    } finally {
        setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center p-4 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-800 via-gray-950 to-black">
      <CustomStyles />
      <div className="w-full max-w-md glass-card p-8 rounded-2xl shadow-2xl border-t border-zinc-700">
        <div className="text-center mb-8">
          <div className="w-20 h-20 bg-amber-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-amber-500/20 shadow-[0_0_30px_rgba(245,158,11,0.2)]">
            <Zap className="text-amber-400" size={40} />
          </div>
          <h2 className="text-3xl font-bold text-white tracking-tight">Marombiew Bot</h2>
          <p className="text-zinc-500 text-sm mt-2 font-medium">Painel de Controlo Inteligente</p>
        </div>
        
        {error && (
          <div className="bg-red-500/10 border border-red-500/20 text-red-400 text-sm p-3 rounded-xl mb-4 text-center">
            {error}
          </div>
        )}
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="space-y-1">
            <label className="text-xs text-zinc-400 font-medium ml-1">Email</label>
            <div className="relative">
               <input 
                type="email" 
                value={email}
                onChange={e => setEmail(e.target.value)}
                required
                className="w-full bg-zinc-900/50 border border-zinc-700 text-zinc-200 text-sm rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500 outline-none transition-all placeholder:text-zinc-600" 
                placeholder="admin@marombiew.com" 
               />
               <div className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"><Search size={16}/></div>
            </div>
          </div>
          <div className="space-y-1">
            <label className="text-xs text-zinc-400 font-medium ml-1">Senha</label>
            <div className="relative">
              <input 
                type="password"
                value={pass}
                onChange={e => setPass(e.target.value)} 
                required
                className="w-full bg-zinc-900/50 border border-zinc-700 text-zinc-200 text-sm rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500 outline-none transition-all placeholder:text-zinc-600" 
                placeholder="••••••••" 
              />
              <div className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"><Lock size={16}/></div>
            </div>
          </div>
          
          <div className="flex flex-col gap-3 mt-6">
            <button 
              type="submit" 
              disabled={loading}
              className="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-amber-900/20 transition-all active:scale-[0.98] flex justify-center items-center gap-2"
            >
              {loading ? <RefreshCw className="animate-spin" size={20} /> : 'Aceder ao Sistema'}
            </button>
            
            <button 
              type="button"
              onClick={handleDemoLogin}
              className="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-medium py-3.5 rounded-xl border border-zinc-700 transition-all flex justify-center items-center gap-2"
            >
              <User size={18} /> Entrar como Demo
            </button>
          </div>
        </form>
        <p className="text-center text-xs text-zinc-600 mt-6">v2.5.2 API-Connected (Rest)</p>
      </div>
    </div>
  );
};

export default function BotDashboard() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('home');
  const [botStatus, setBotStatus] = useState('PAUSED');
  const [signals, setSignals] = useState([]);
  const [catalog, setCatalog] = useState([]);
  const [config, setConfig] = useState(null);
  const [toast, setToast] = useState(null);
  const [balance, setBalance] = useState({ current: 0, initial: 0 });
  const [logs, setLogs] = useState([]);

  // --- Data Fetching & Realtime Polling ---
  
  useEffect(() => {
    if (!user) return;

    const refreshData = async () => {
        try {
            // Se for demo user e a API falhar, não crashar
            // Signals
            const sData = await supabaseFetch('trade_signals?select=*&order=created_at.desc&limit=50');
            if (sData) setSignals(sData);

            // Config
            const cData = await supabaseFetch('bot_config?select=*&id=eq.1');
            if (cData && cData.length > 0) {
                const cfg = cData[0];
                setConfig(cfg);
                setBotStatus(cfg.status || 'PAUSED');
                setBalance({ current: cfg.current_balance || 0, initial: cfg.daily_initial_balance || 0 });
            }

            // Catalog
            const catData = await supabaseFetch('cataloged_assets?select=*&order=win_rate.desc');
            if (catData) setCatalog(catData);

            // Logs
            const lData = await supabaseFetch('logs?select=*&order=created_at.desc&limit=50');
            if (lData) setLogs(lData.reverse());

        } catch (error) {
            console.error("Refresh error", error);
        }
    };

    refreshData();
    const interval = setInterval(refreshData, 3000); // Poll a cada 3s para simular realtime
    return () => clearInterval(interval);
  }, [user]);

  // Stats calculation
  const stats = useMemo(() => {
    const wins = signals.filter(s => s.result === 'WIN').length;
    const losses = signals.filter(s => s.result === 'LOSS').length;
    return { wins, losses, total: wins + losses };
  }, [signals]);

  const assertiveness = stats.total > 0 ? ((stats.wins / stats.total) * 100).toFixed(0) : 0;
  const profit = balance.current - balance.initial;

  const handleLogout = () => setUser(null);

  const showToast = (msg, type = 'info') => {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 3000);
  };

  const toggleBotStatus = async () => {
      // Se for demo user sem config real, simular
      if (!config && user?.id === 'demo-user') {
         const newS = botStatus === 'RUNNING' ? 'PAUSED' : 'RUNNING';
         setBotStatus(newS);
         showToast(`Modo Demo: Bot ${newS}`, 'success');
         return;
      }

      if (!config) return;
      const newStatus = botStatus === 'RUNNING' ? 'PAUSED' : 'RUNNING';
      
      const res = await supabaseFetch('bot_config?id=eq.1', {
          method: 'PATCH',
          body: JSON.stringify({ status: newStatus })
      });

      if (res === null) {
          // Fallback para demo se falhar a escrita
          setBotStatus(newStatus);
          showToast(`Estado atualizado localmente (Erro API)`, 'warning');
      } else {
          setBotStatus(newStatus);
          showToast(`Bot ${newStatus === 'RUNNING' ? 'Iniciado' : 'Pausado'}`, newStatus === 'RUNNING' ? 'success' : 'info');
      }
  };

  const updateConfig = async (key, value) => {
      setConfig(prev => ({ ...prev, [key]: value })); // Optimistic update
      
      // Se for demo user, não tentar salvar na API se não tiver permissão
      if (user?.id === 'demo-user') return;

      const res = await supabaseFetch('bot_config?id=eq.1', {
          method: 'PATCH',
          body: JSON.stringify({ [key]: value })
      });
      if (res === null) showToast("Erro ao salvar (Verifique permissões)", "error");
  };

  const NavItem = ({ id, icon: Icon, label }) => (
    <button 
      onClick={() => setView(id)}
      className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all w-full md:w-auto md:justify-start justify-center
        ${view === id 
          ? 'bg-amber-500/10 text-amber-400 shadow-[0_0_15px_rgba(245,158,11,0.1)] border border-amber-500/20' 
          : 'text-zinc-500 hover:text-zinc-200 hover:bg-zinc-800/50'
        }`}
    >
      <Icon size={20} className={view === id ? 'text-amber-400' : ''} />
      <span className="hidden md:block font-medium text-sm">{label}</span>
    </button>
  );

  if (!user) return <LoginView onLogin={setUser} />;

  return (
    <div className="min-h-screen bg-[#111827] text-zinc-100 font-sans flex flex-col md:flex-row overflow-hidden selection:bg-amber-500/30">
      <CustomStyles />
      {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)} />}

      {/* Sidebar Desktop */}
      <aside className="hidden md:flex flex-col w-64 bg-[#1f2937]/50 backdrop-blur-md border-r border-zinc-800 h-screen z-20">
        <div className="h-20 flex items-center px-6 border-b border-zinc-800/50">
          <Zap className="text-amber-400 mr-3" size={24} fill="currentColor" />
          <span className="font-bold text-lg tracking-wider text-white">MAROMBIEW</span>
        </div>
        
        <nav className="flex-1 p-4 space-y-2">
          <NavItem id="home" icon={LayoutDashboard} label="Dashboard" />
          <NavItem id="strategies" icon={Layers} label="Estratégias" />
          <NavItem id="settings" icon={Settings} label="Configurações" />
          <NavItem id="logs" icon={Terminal} label="Logs do Sistema" />
        </nav>

        <div className="p-4 border-t border-zinc-800/50">
          <div className="px-4 py-2 mb-2 text-xs text-zinc-500">
             Logado como: <span className="text-zinc-300 block truncate">{user.email}</span>
          </div>
          <button onClick={handleLogout} className="flex items-center gap-3 px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 rounded-xl w-full transition-colors">
            <LogOut size={18} /> Sair
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
        <div className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-24 md:pb-8">
          
          {/* VIEW: DASHBOARD */}
          {view === 'home' && (
            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 max-w-5xl mx-auto">
              <div className="flex justify-between items-end">
                <div>
                  <h1 className="text-2xl font-bold text-white">Dashboard</h1>
                  <p className="text-zinc-500 text-xs">Visão geral das operações de hoje.</p>
                </div>
                <div className="flex gap-2">
                   <button 
                    onClick={toggleBotStatus}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-all ${
                        botStatus === 'RUNNING' 
                        ? 'bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20' 
                        : 'bg-green-500 text-white hover:bg-green-400 shadow-green-500/20'
                    }`}
                   >
                     {botStatus === 'RUNNING' ? <Pause size={16} fill="currentColor"/> : <Play size={16} fill="currentColor"/>}
                     {botStatus === 'RUNNING' ? 'PAUSAR BOT' : 'INICIAR BOT'}
                   </button>
                </div>
              </div>

              {/* Scanner */}
              <ScannerWidget botStatus={botStatus} />

              {/* Financial Cards */}
              <div className="grid grid-cols-2 gap-4">
                <div className="glass-card p-5 rounded-xl relative overflow-hidden group">
                   <div className="absolute -right-4 -top-4 text-zinc-800 opacity-50 group-hover:opacity-100 group-hover:scale-110 transition-all duration-500">
                     <Wallet size={80} />
                   </div>
                   <p className="text-xs text-zinc-500 font-bold uppercase tracking-wider mb-1">Saldo Atual</p>
                   <p className="text-2xl font-bold text-white">${Number(balance.current).toFixed(2)}</p>
                </div>
                <div className="glass-card p-5 rounded-xl relative overflow-hidden group">
                   <div className={`absolute -right-4 -top-4 opacity-50 group-hover:opacity-100 group-hover:scale-110 transition-all duration-500 ${profit >= 0 ? 'text-green-900' : 'text-red-900'}`}>
                     <Activity size={80} />
                   </div>
                   <p className="text-xs text-zinc-500 font-bold uppercase tracking-wider mb-1">Resultado (Dia)</p>
                   <p className={`text-2xl font-bold flex items-center gap-1 ${profit >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                     {profit >= 0 ? <TrendingUp size={20} /> : <TrendingDown size={20} />}
                     {profit >= 0 ? '+' : ''}{profit.toFixed(2)}
                   </p>
                </div>
              </div>

              {/* Scoreboard */}
              <div className="glass-card p-4 rounded-xl border-t-4 border-amber-500">
                <div className="flex divide-x divide-zinc-700">
                  <div className="flex-1 px-2 text-center">
                    <p className="text-[10px] text-green-500 font-bold mb-1">WINS</p>
                    <span className="text-2xl font-bold text-white">{stats.wins}</span>
                  </div>
                  <div className="flex-1 px-2 text-center">
                    <p className="text-[10px] text-red-500 font-bold mb-1">LOSS</p>
                    <span className="text-2xl font-bold text-white">{stats.losses}</span>
                  </div>
                  <div className="flex-1 px-2 text-center">
                    <p className="text-[10px] text-blue-400 font-bold mb-1">ASSERT.</p>
                    <span className="text-2xl font-bold text-white">{assertiveness}%</span>
                  </div>
                  <div className="flex-1 px-2 flex justify-center items-center">
                     <CountdownTimer />
                  </div>
                </div>
              </div>

              {/* Signals List */}
              <div>
                <h3 className="text-sm font-bold text-zinc-400 uppercase tracking-wide mb-3 flex items-center gap-2">
                  <Activity size={14} /> Histórico de Sinais
                </h3>
                <div className="space-y-3">
                  {signals.length === 0 ? (
                    <p className="text-center text-zinc-600 py-10">A aguardar primeiros sinais...</p>
                  ) : signals.map((signal) => (
                    <div key={signal.id} className="glass-card p-4 rounded-xl flex items-center justify-between hover:bg-zinc-800/50 transition-colors border-l-4" style={{borderLeftColor: signal.direction === 'call' ? '#22c55e' : '#ef4444'}}>
                      <div className="flex items-center gap-4">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${signal.direction === 'call' ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500'}`}>
                          {signal.direction === 'call' ? <ArrowUp size={20} /> : <ArrowDown size={20} />}
                        </div>
                        <div>
                          <p className="font-bold text-white text-sm">{signal.pair}</p>
                          <div className="flex items-center gap-2">
                             <span className="text-[10px] text-zinc-500 bg-zinc-900 px-1.5 py-0.5 rounded">{new Date(signal.created_at).toLocaleTimeString()}</span>
                             <span className="text-[10px] text-zinc-400">{signal.strategy}</span>
                          </div>
                        </div>
                      </div>
                      <div className="text-right">
                        {signal.result === 'WIN' && <span className="text-green-400 font-bold text-sm flex items-center gap-1"><Check size={14} /> WIN</span>}
                        {signal.result === 'LOSS' && <span className="text-red-400 font-bold text-sm flex items-center gap-1"><X size={14} /> LOSS</span>}
                        {(!signal.result || signal.result === 'PENDING') && <span className="text-amber-400 text-xs font-bold animate-pulse flex items-center gap-1"><RefreshCw size={12} className="animate-spin"/> Em Curso</span>}
                        {signal.martingale_level > 0 && <span className="block text-[9px] text-orange-400 font-mono mt-0.5">Gale {signal.martingale_level}</span>}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* VIEW: STRATEGIES */}
          {view === 'strategies' && (
            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 max-w-3xl mx-auto">
               <h1 className="text-2xl font-bold text-white">Catalogador</h1>
               
               <div className="glass-card p-6 rounded-xl">
                 <div className="flex justify-between items-center mb-6">
                   <h2 className="text-sm font-bold text-zinc-300">Filtro de Assertividade</h2>
                   <span className="text-amber-400 font-bold text-2xl">{config?.min_win_rate || 80}%</span>
                 </div>
                 <input 
                    type="range" 
                    className="w-full h-2 bg-zinc-700 rounded-lg appearance-none cursor-pointer accent-amber-500" 
                    min="50" max="99" 
                    value={config?.min_win_rate || 80}
                    onChange={(e) => updateConfig('min_win_rate', Number(e.target.value))}
                 />
                 <p className="text-xs text-zinc-500 mt-2">Apenas pares com assertividade acima do selecionado serão operados.</p>
               </div>

               <div className="space-y-3">
                 <h2 className="text-sm font-bold text-zinc-500 uppercase tracking-wide">Melhores Ativos (M5)</h2>
                 {catalog.map(asset => (
                   <div key={asset.pair} className="glass-card p-4 rounded-xl flex items-center justify-between group hover:border-amber-500/30 transition-all">
                     <div>
                       <div className="flex items-center gap-2">
                         <p className="font-bold text-white">{asset.pair}</p>
                         {asset.win_rate > 90 && <Zap size={12} className="text-amber-400 fill-amber-400" />}
                       </div>
                       <p className="text-xs text-zinc-400 mt-1">
                         Melhor Estratégia: <span className="text-amber-400">{asset.best_strategy}</span>
                       </p>
                     </div>
                     <div className="text-right">
                       <div className={`text-xl font-bold ${asset.win_rate >= 80 ? 'text-green-400' : asset.win_rate >= 60 ? 'text-amber-400' : 'text-red-400'}`}>
                         {asset.win_rate.toFixed(1)}%
                       </div>
                       <div className="text-[10px] space-x-2">
                         <span className="text-green-500">{asset.wins}W</span>
                         <span className="text-zinc-600">|</span>
                         <span className="text-red-500">{asset.losses}L</span>
                       </div>
                     </div>
                   </div>
                 ))}
               </div>
            </div>
          )}

          {/* VIEW: SETTINGS */}
          {view === 'settings' && (config || user?.id === 'demo-user') && (
            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 max-w-3xl mx-auto">
              <h1 className="text-2xl font-bold text-white">Configurações</h1>

              <div className="glass-card p-6 rounded-xl space-y-8">
                <div>
                   <h3 className="text-sm font-bold text-amber-500 uppercase tracking-wide mb-4 flex items-center gap-2">
                     <Lock size={14} /> Gerenciamento de Risco
                   </h3>
                   <div className="grid grid-cols-2 gap-4">
                     <div className="space-y-2">
                       <label className="text-xs text-zinc-400 block">Stop Win</label>
                       <input 
                        type="number" 
                        value={config?.stop_win || 500}
                        onChange={(e) => updateConfig('stop_win', Number(e.target.value))}
                        className="w-full bg-zinc-900 border border-zinc-700 rounded-lg p-3 text-green-400 font-bold outline-none focus:border-green-500" 
                       />
                     </div>
                     <div className="space-y-2">
                       <label className="text-xs text-zinc-400 block">Stop Loss</label>
                       <input 
                        type="number" 
                        value={config?.stop_loss || 200}
                        onChange={(e) => updateConfig('stop_loss', Number(e.target.value))}
                        className="w-full bg-zinc-900 border border-zinc-700 rounded-lg p-3 text-red-400 font-bold outline-none focus:border-red-500" 
                       />
                     </div>
                   </div>
                </div>

                <div className="border-t border-zinc-700/50 pt-6">
                  <div className="flex justify-between items-center mb-4">
                     <h3 className="text-sm font-bold text-amber-500 uppercase tracking-wide flex items-center gap-2">
                       <Layers size={14} /> Martingale
                     </h3>
                     <div className="flex items-center gap-2">
                       <span className="text-xs text-zinc-400">{config?.use_martingale ? 'Ativado' : 'Desativado'}</span>
                       <button 
                        onClick={() => updateConfig('use_martingale', !config?.use_martingale)}
                        className={`w-10 h-5 rounded-full relative cursor-pointer transition-colors ${config?.use_martingale ? 'bg-amber-500' : 'bg-zinc-700'}`}
                       >
                         <div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all shadow-sm ${config?.use_martingale ? 'right-1' : 'left-1'}`}></div>
                       </button>
                     </div>
                  </div>
                  
                  {config?.use_martingale && (
                    <div className="grid grid-cols-2 gap-4">
                       <div className="space-y-2">
                         <label className="text-xs text-zinc-400 block">Níveis de Gale</label>
                         <input 
                            type="number" 
                            value={config.martingale_levels} 
                            onChange={(e) => updateConfig('martingale_levels', Number(e.target.value))}
                            className="w-full bg-zinc-900 border border-zinc-700 rounded-lg p-3 text-white outline-none" 
                         />
                       </div>
                       <div className="space-y-2">
                         <label className="text-xs text-zinc-400 block">Fator Multiplicador</label>
                         <input 
                            type="number" 
                            step="0.1"
                            value={config.martingale_factor} 
                            onChange={(e) => updateConfig('martingale_factor', Number(e.target.value))}
                            className="w-full bg-zinc-900 border border-zinc-700 rounded-lg p-3 text-white font-bold outline-none focus:border-amber-500" 
                         />
                       </div>
                    </div>
                  )}
                </div>

                <div className="border-t border-zinc-700/50 pt-6">
                   <h3 className="text-sm font-bold text-amber-500 uppercase tracking-wide mb-4 flex items-center gap-2">
                     <Wallet size={14} /> Operacional
                   </h3>
                   <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-2">
                       <label className="text-xs text-zinc-400 block">Valor Entrada ($)</label>
                       <input 
                        type="number" 
                        value={config?.entry_value || 10} 
                        onChange={(e) => updateConfig('entry_value', Number(e.target.value))}
                        className="w-full bg-zinc-900 border border-zinc-700 rounded-lg p-3 text-white font-bold outline-none focus:border-amber-500" 
                       />
                     </div>
                     <div className="space-y-2">
                       <label className="text-xs text-zinc-400 block">Conta</label>
                       <select 
                        value={config?.account_type || 'PRACTICE'} 
                        onChange={(e) => updateConfig('account_type', e.target.value)}
                        className="w-full bg-zinc-900 border border-zinc-700 rounded-lg p-3 text-white outline-none"
                       >
                         <option value="PRACTICE">DEMO (Treino)</option>
                         <option value="REAL">REAL</option>
                       </select>
                     </div>
                   </div>
                </div>
              </div>
            </div>
          )}

          {/* VIEW: LOGS */}
          {view === 'logs' && (
            <div className="h-full flex flex-col animate-in fade-in slide-in-from-bottom-4 duration-500">
               <h1 className="text-2xl font-bold text-white mb-4">Terminal do Sistema</h1>
               <div className="flex-1 glass-card rounded-xl p-4 overflow-y-auto font-mono text-xs space-y-2 border border-zinc-700 bg-black/60 shadow-inner">
                 <div className="text-zinc-500 mb-4 pb-2 border-b border-zinc-800">
                   Marombiew Bot v2.5.2 - Connected via REST
                   <br/>Server: {SUPABASE_URL.split('//')[1]}
                 </div>
                 {logs.map((log) => (
                   <div key={log.id} className="flex gap-2 opacity-80 hover:opacity-100 transition-opacity">
                     <span className="text-zinc-600 shrink-0">[{new Date(log.created_at).toLocaleTimeString()}]</span>
                     <span className={`${log.level === 'ERROR' ? 'text-red-400' : log.level === 'WARNING' ? 'text-amber-400' : log.level === 'SUCCESS' ? 'text-green-400' : 'text-zinc-300'}`}>
                       {log.level}: {log.message}
                     </span>
                   </div>
                 ))}
                 <div className="animate-pulse text-amber-500">_</div>
               </div>
            </div>
          )}

        </div>

        {/* Mobile Navigation (Bottom Bar) */}
        <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-[#1f2937]/95 backdrop-blur-xl border-t border-zinc-800 flex justify-around px-2 pb-safe z-40 h-16 items-center">
           <button onClick={() => setView('home')} className={`flex flex-col items-center p-2 ${view === 'home' ? 'text-amber-400' : 'text-zinc-500'}`}>
             <LayoutDashboard size={20} />
             <span className="text-[10px] mt-1">Dash</span>
           </button>
           <button onClick={() => setView('strategies')} className={`flex flex-col items-center p-2 ${view === 'strategies' ? 'text-amber-400' : 'text-zinc-500'}`}>
             <Layers size={20} />
             <span className="text-[10px] mt-1">Estrat.</span>
           </button>
           
           <div className="relative -top-6">
             <button 
               onClick={() => setView('settings')}
               className={`w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-4 border-[#111827] transition-all ${view === 'settings' ? 'bg-amber-500 text-white' : 'bg-zinc-700 text-zinc-300'}`}
             >
               <Settings size={24} />
             </button>
           </div>

           <button onClick={() => setView('logs')} className={`flex flex-col items-center p-2 ${view === 'logs' ? 'text-amber-400' : 'text-zinc-500'}`}>
             <Terminal size={20} />
             <span className="text-[10px] mt-1">Logs</span>
           </button>
           <button onClick={handleLogout} className="flex flex-col items-center p-2 text-zinc-500">
             <LogOut size={20} />
             <span className="text-[10px] mt-1">Sair</span>
           </button>
        </nav>
      </main>
    </div>
  );
}
