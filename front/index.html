<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MAROMBIEW BOT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0a0a0a; color: #e5e7eb; font-family: 'Poppins', sans-serif; }
        .glass-card { background: rgba(17, 24, 39, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .form-input { background-color: #1f2937; border-color: #374151; }
        .btn-primary { background-color: #0d9488; }
        .btn-primary:hover { background-color: #14b8a6; }
        .nav-link-active { background-color: #14b8a6; color: white; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, Component } = React;
        const { createClient } = supabase;

        // --- INFORMAÇÕES DE CONEXÃO COM O SUPABASE ---
        const SUPABASE_URL = 'https://ioduahwknfsktujthfyc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZHVhaHdrbmZza3R1anRoZnljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMDc0NDcsImV4cCI6MjA2Njg4MzQ0N30.96f8wZO6SvABKFMWjIiw1pSugAB4Isldj7yxLcLJRSE';
        
        let supabaseClient;
        let supabaseInitializationError = null;

        if (SUPABASE_URL.includes('SEU_URL') || SUPABASE_ANON_KEY.includes('SUA_CHAVE')) {
            supabaseInitializationError = "As credenciais do Supabase não foram definidas no ficheiro HTML. Edite o ficheiro e substitua 'SEU_URL_DO_SUPABASE' e 'SUA_CHAVE_ANON_DO_SUPABASE' pelas suas chaves reais.";
        } else {
            try {
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } catch (e) {
                supabaseInitializationError = `Erro ao inicializar o Supabase: ${e.message}`;
            }
        }
        
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("React Tree Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (<div className="text-center text-red-400 p-8 glass-card rounded-xl max-w-lg mx-auto"><h1 className="text-2xl font-bold mb-2"><i className="fa-solid fa-triangle-exclamation mr-2"></i>Oops! Algo correu mal.</h1><p>A aplicação encontrou um erro. Por favor, tente atualizar a página.</p><pre className="mt-4 text-xs text-left bg-gray-900 p-2 rounded overflow-auto">{this.state.error && this.state.error.toString()}</pre></div>);
                }
                return this.props.children;
            }
        }

        function LoginPage() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    setError(error.message);
                    setLoading(false);
                }
                // On success, the onAuthStateChange listener in App will handle navigation.
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900">
                    <div className="w-full max-w-md p-8 space-y-8 glass-card rounded-xl">
                        <div><h2 className="mt-6 text-center text-3xl font-extrabold text-white">Admin Login</h2></div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div className="rounded-md shadow-sm -space-y-px">
                                <div><input type="email" required className="form-input appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 text-gray-300 rounded-t-md focus:outline-none focus:ring-teal-500 focus:border-teal-500" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} /></div>
                                <div><input type="password" required className="form-input appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 text-gray-300 rounded-b-md focus:outline-none focus:ring-teal-500 focus:border-teal-500" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} /></div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div><button type="submit" className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500" disabled={loading}>{loading ? 'A entrar...' : 'Entrar'}</button></div>
                        </form>
                    </div>
                </div>
            );
        }
        
        function AdminDashboard() {
            const [view, setView] = useState('bot_control');
            const handleLogout = async () => { await supabaseClient.auth.signOut(); };

            return (
                <div className="flex h-screen bg-gray-900">
                    <aside className="w-64 bg-gray-800 text-white flex flex-col">
                        <div className="h-16 flex items-center justify-center text-2xl font-bold border-b border-gray-700">Admin</div>
                        <nav className="flex-1 px-2 py-4 space-y-2">
                            <a href="#" onClick={() => setView('bot_control')} className={`block px-4 py-2 rounded-md ${view === 'bot_control' ? 'nav-link-active' : ''}`}>Controlo do Bot</a>
                            <a href="#" onClick={() => setView('user_management')} className={`block px-4 py-2 rounded-md ${view === 'user_management' ? 'nav-link-active' : ''}`}>Gestão de Alunos</a>
                        </nav>
                        <div className="p-4 border-t border-gray-700"><button onClick={handleLogout} className="w-full text-left px-4 py-2 rounded-md hover:bg-red-500">Sair</button></div>
                    </aside>
                    <main className="flex-1 p-10 overflow-y-auto">
                        {view === 'bot_control' && <BotControl />}
                        {view === 'user_management' && <UserManagement />}
                    </main>
                </div>
            );
        }
        
        function BotControl() {
            const [botStatus, setBotStatus] = useState('PAUSED');
            const [params, setParams] = useState('');
            const [loading, setLoading] = useState(false);

            const fetchConfig = useCallback(async () => {
                const { data } = await supabaseClient.table('bot_config').select('*').eq('id', 1).single();
                if (data) {
                    setBotStatus(data.status);
                    setParams(JSON.stringify(data.params, null, 2));
                }
            }, []);

            useEffect(() => { fetchConfig(); }, [fetchConfig]);

            const handleStatusChange = async (newStatus) => {
                setLoading(true);
                await supabaseClient.table('bot_config').update({ status: newStatus }).eq('id', 1);
                fetchConfig();
                setLoading(false);
            };

            const handleParamsSave = async () => {
                try {
                    const parsedParams = JSON.parse(params);
                    setLoading(true);
                    await supabaseClient.table('bot_config').update({ params: parsedParams }).eq('id', 1);
                    alert('Parâmetros guardados com sucesso!');
                    setLoading(false);
                } catch (e) { alert('Erro: JSON inválido!'); }
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold text-white mb-6">Controlo do Bot</h1>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="glass-card p-6 rounded-xl">
                            <h2 className="text-xl font-bold mb-4">Estado do Bot</h2>
                            <p className="mb-4">Estado atual: <span className={`font-bold ${botStatus === 'RUNNING' ? 'text-green-400' : 'text-amber-400'}`}>{botStatus}</span></p>
                            <div className="flex gap-4">
                                <button onClick={() => handleStatusChange('RUNNING')} className="btn-primary px-4 py-2 rounded-md disabled:opacity-50" disabled={loading || botStatus === 'RUNNING'}>Iniciar Bot</button>
                                <button onClick={() => handleStatusChange('PAUSED')} className="bg-amber-500 hover:bg-amber-600 px-4 py-2 rounded-md disabled:opacity-50" disabled={loading || botStatus === 'PAUSED'}>Pausar Bot</button>
                            </div>
                        </div>
                         <div className="glass-card p-6 rounded-xl">
                            <h2 className="text-xl font-bold mb-4">Parâmetros das Estratégias</h2>
                            <textarea value={params} onChange={(e) => setParams(e.target.value)} className="form-input w-full h-64 font-mono text-sm p-2 rounded-md"></textarea>
                            <button onClick={handleParamsSave} className="mt-4 btn-primary w-full py-2 rounded-md disabled:opacity-50" disabled={loading}>Guardar Parâmetros</button>
                        </div>
                    </div>
                </div>
            );
        }

        function UserManagement() {
            const [users, setUsers] = useState([]);
            const fetchUsers = useCallback(async () => {
                const { data } = await supabaseClient.from('profiles').select(`id, email, role, subscriptions ( status, expires_at )`);
                if(data) setUsers(data);
            }, []);

            useEffect(() => { fetchUsers(); }, [fetchUsers]);
            
            const handleSubscriptionChange = async (userId, newStatus, newExpiry) => {
                 const { data } = await supabaseClient.from('subscriptions').select('user_id').eq('user_id', userId).single();
                if (data) await supabaseClient.from('subscriptions').update({ status: newStatus, expires_at: newExpiry }).eq('user_id', userId);
                else await supabaseClient.from('subscriptions').insert({ user_id: userId, status: newStatus, expires_at: newExpiry });
                fetchUsers();
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold text-white mb-6">Gestão de Alunos</h1>
                    <div className="glass-card rounded-xl overflow-hidden">
                        <table className="min-w-full">
                            <thead className="bg-gray-800">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Email</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Estado</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Expira em</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-700">
                                {users.filter(u => u.role === 'user').map(user => {
                                    const sub = user.subscriptions[0] || {};
                                    const expiryDate = sub.expires_at ? new Date(sub.expires_at).toISOString().split('T')[0] : '';
                                    return (
                                        <tr key={user.id}>
                                            <td className="px-6 py-4 whitespace-nowrap">{user.email}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">{sub.status || 'inactive'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">{expiryDate}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <button onClick={() => {
                                                    const newDate = prompt("Nova data de expiração (YYYY-MM-DD):", expiryDate);
                                                    if(newDate) handleSubscriptionChange(user.id, 'active', newDate);
                                                }} className="text-teal-400 hover:text-teal-300">Editar</button>
                                                <button onClick={() => handleSubscriptionChange(user.id, 'inactive', sub.expires_at)} className="text-red-400 hover:text-red-300">Desativar</button>
                                            </td>
                                        </tr>
                                    )
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function App() {
            const [session, setSession] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (supabaseInitializationError) {
                    setLoading(false);
                    return;
                }

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(async (_event, session) => {
                    setSession(session);
                    if (session) {
                        const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
                        setUserProfile(profile);
                    } else {
                        setUserProfile(null);
                    }
                    setLoading(false);
                });

                return () => subscription.unsubscribe();
            }, []);

            if (supabaseInitializationError) {
                return <div className="min-h-screen flex items-center justify-center text-red-400 p-4"><div className="glass-card p-8 rounded-xl max-w-lg text-center"><h1 className="text-2xl font-bold mb-4">Erro de Configuração</h1><p>{supabaseInitializationError}</p></div></div>;
            }

            if (loading) {
                return <div className="min-h-screen flex items-center justify-center"><p>A carregar...</p></div>;
            }

            if (!session) {
                return <LoginPage />;
            }
            
            if (userProfile && userProfile.role === 'admin') {
                return <AdminDashboard />;
            }
            
            // Aqui entraria a lógica para o painel do cliente
            return <div className="min-h-screen flex items-center justify-center"><p>A verificar permissões...</p></div>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
