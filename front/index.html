<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAROMBIEW BOT</title>

    <meta name="theme-color" content="#191919">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MarombiewBot">
    
    <!-- Scripts e Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- React & Supabase -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-dark: #191919; --bg-medium: #1f2937; --border-color: #374151;
            --text-primary: #f9fafb; --text-secondary: #9ca3af; --accent-primary: #f59e0b;
            --accent-primary-hover: #fbbf24; --accent-red: #ef4444; 
            --accent-win: #22c55e; --accent-loss: #f87171; --accent-info: #3b82f6;
        }
        body { background-color: var(--bg-dark); color: var(--text-primary); font-family: 'Poppins', sans-serif; overflow: hidden; }
        
        /* Glassmorphism */
        .glass-card { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--border-color); }
        
        /* Form Elements */
        .form-input, .form-select { background-color: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); transition: all 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2); }
        
        /* Utility */
        .btn { transition: all 0.2s; border: none; font-weight: 600; cursor: pointer; }
        .btn:active { transform: scale(0.98); }
        .nav-link-active { background-color: var(--accent-primary); color: var(--bg-dark); }
        
        /* Toggles */
        .toggle-bg:after { content: ''; position: absolute; top: 2px; left: 2px; background: white; border-radius: 9999px; height: 1.25rem; width: 1.25rem; transition: all 0.2s; }
        input:checked + .toggle-bg:after { transform: translateX(100%); }
        input:checked + .toggle-bg { background-color: var(--accent-primary); }
        
        /* Loading */
        .spinner { border: 3px solid rgba(245, 158, 11, 0.2); border-top-color: var(--accent-primary); border-radius: 50%; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Splash Screen */
        #static-splash { position: fixed; inset: 0; background-color: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.4s ease-out; }

        /* Toast Notifications */
        .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 50; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- ANIMAÇÕES DO SCANNER --- */
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
            animation: scanMove 1.5s linear infinite;
            opacity: 0.8;
            box-shadow: 0 0 10px var(--accent-primary);
        }
        @keyframes scanMove {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        .pulse-ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
            opacity: 0;
            animation: pulseEffect 2s ease-out infinite;
        }
        @keyframes pulseEffect {
            0% { transform: scale(0.5); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .ticker-text {
            font-family: 'Roboto Mono', monospace;
            animation: fadeSwitch 0.2s ease-in-out;
        }
        @keyframes fadeSwitch {
            0% { opacity: 0.5; transform: translateY(2px); }
            100% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="static-splash">
        <i class="fas fa-robot" style="color: #f59e0b; font-size: 60px; margin-bottom: 1rem;"></i>
        <h1 style="font-size: 1.875rem; font-weight: 700; color: white; margin-bottom: 0.5rem;">MAROMBIEW BOT</h1>
        <div class="spinner"></div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef, createContext, useContext } = React;
        const { createClient } = supabase;

        // Configuração Supabase
        const SUPABASE_URL = 'https://ioduahwknfsktujthfyc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZHVhaHdrbmZza3R1anRoZnljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMDc0NDcsImV4cCI6MjA2Njg4MzQ0N30.96f8wZO6SvABKFMWjIiw1pSugAB4Isldj7yxLcLJRSE';
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Contexto de Toast (Notificações) ---
        const ToastContext = createContext();
        const useToast = () => useContext(ToastContext);

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = (msg, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => removeToast(id), 3000);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="toast-container">
                        {toasts.map(t => (
                            <div key={t.id} className={`toast px-4 py-3 rounded-lg shadow-lg text-sm font-medium flex items-center gap-2 ${
                                t.type === 'error' ? 'bg-red-600 text-white' : 
                                t.type === 'success' ? 'bg-green-600 text-white' : 'bg-gray-800 text-white border border-gray-700'
                            }`}>
                                <i className={`fas ${t.type === 'error' ? 'fa-exclamation-circle' : t.type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}`}></i>
                                {t.msg}
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        // --- Componentes Visual ---
        
        // WIDGET SCANNER INTELIGENTE
        const ScannerWidget = ({ lastLog, botStatus }) => {
            const [currentPair, setCurrentPair] = useState('INICIANDO...');
            const [scanStatus, setScanStatus] = useState('AGUARDANDO');
            const [mode, setMode] = useState('IDLE'); // IDLE, SCANNING, SIGNAL
            
            // Pares para simulação visual (efeito Matrix)
            const pairs = useMemo(() => [
                'EURUSD-OTC', 'GBPUSD-OTC', 'USDJPY-OTC', 'AUDCAD-OTC', 
                'USDCHF-OTC', 'EURGBP-OTC', 'EURJPY-OTC', 'NZDUSD-OTC'
            ], []);

            // 1. Reage aos logs reais
            useEffect(() => {
                if (!lastLog) return;

                // Log de Varredura -> Modo SCANNING (Rápido)
                if (lastLog.message.includes('Varredura')) {
                    setMode('SCANNING');
                    setScanStatus(lastLog.message.includes('M5') ? 'VARREDURA M5' : 'VARREDURA M1');
                    
                    // Após 12s, volta para IDLE (Monitoramento Lento) se não houver sinal
                    const t = setTimeout(() => setMode('IDLE'), 12000);
                    return () => clearTimeout(t);
                }
                
                // Log de Confirmação/Entrada -> Modo SIGNAL (Fixo)
                if (lastLog.message.includes('CONFIRMADO') || lastLog.message.includes('ENTRADA')) {
                    setMode('SIGNAL');
                    setScanStatus('SINAL ENCONTRADO');
                    const match = lastLog.message.match(/([A-Z]{6}(-OTC)?)/);
                    if (match) setCurrentPair(match[0]);
                    
                    // Segura o sinal na tela por 30s
                    const t = setTimeout(() => setMode('IDLE'), 30000);
                    return () => clearTimeout(t);
                }
            }, [lastLog]);

            // 2. Controla o estado "IDLE" baseado no status global do bot
            useEffect(() => {
                if (botStatus === 'PAUSED') {
                    setMode('OFF');
                    setScanStatus('SISTEMA PAUSADO');
                    setCurrentPair('---');
                } else if (mode === 'OFF' && botStatus === 'RUNNING') {
                    setMode('IDLE');
                }
            }, [botStatus]);

            // 3. Loop de Animação Visual (Ciclo de Pares)
            useEffect(() => {
                let interval;
                
                if (mode === 'SCANNING') {
                    // Troca muito rápida (Efeito processamento)
                    interval = setInterval(() => {
                        const randomPair = pairs[Math.floor(Math.random() * pairs.length)];
                        setCurrentPair(randomPair);
                    }, 100); 
                } else if (mode === 'IDLE' && botStatus === 'RUNNING') {
                    // Troca lenta (Efeito monitoramento constante)
                    setScanStatus('MONITORANDO MERCADO');
                    interval = setInterval(() => {
                        const randomPair = pairs[Math.floor(Math.random() * pairs.length)];
                        setCurrentPair(randomPair);
                    }, 2000);
                } else if (mode === 'SIGNAL') {
                    // Fixo no par do sinal
                    clearInterval(interval);
                }

                return () => clearInterval(interval);
            }, [mode, botStatus, pairs]);

            // Cores dinâmicas
            const getStatusColor = () => {
                if (mode === 'SIGNAL') return 'text-green-400';
                if (mode === 'SCANNING') return 'text-amber-400';
                if (mode === 'IDLE') return 'text-blue-400';
                return 'text-gray-500';
            };

            const getBgColor = () => {
                if (mode === 'SIGNAL') return 'bg-green-500';
                if (mode === 'SCANNING') return 'bg-amber-500';
                if (mode === 'IDLE') return 'bg-blue-500';
                return 'bg-gray-700';
            };

            return (
                <div className={`glass-card rounded-xl p-0 overflow-hidden relative transition-colors duration-500 border ${mode === 'SIGNAL' ? 'border-green-500/50' : mode === 'SCANNING' ? 'border-amber-500/50' : 'border-gray-700'}`}>
                    {/* Background Grid Effect */}
                    <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10"></div>
                    
                    {/* Scan Line Animation (Só quando scanning) */}
                    {mode === 'SCANNING' && <div className="scan-line z-10"></div>}

                    <div className="p-5 relative z-20 flex justify-between items-center">
                        <div>
                            <div className="flex items-center gap-2 mb-1">
                                <div className={`w-2 h-2 rounded-full ${mode !== 'OFF' ? 'animate-pulse' : ''} ${getBgColor()}`}></div>
                                <span className={`text-[10px] font-bold tracking-widest uppercase ${getStatusColor()}`}>
                                    {scanStatus}
                                </span>
                            </div>
                            <div className="text-3xl font-black text-white tracking-tight ticker-text">
                                {currentPair}
                            </div>
                            <p className="text-xs text-gray-400 mt-1 flex items-center gap-1">
                                <i className={`fas fa-microchip ${mode !== 'OFF' ? 'text-green-500' : 'text-gray-600'}`}></i> 
                                {mode === 'OFF' ? 'IA Desativada' : 'IA Operacional'}
                            </p>
                        </div>

                        {/* Radar Circle */}
                        <div className="relative w-16 h-16 flex items-center justify-center">
                            {/* Anel Externo Giratório */}
                            <div className={`w-full h-full border border-gray-700 rounded-full absolute ${mode === 'SCANNING' ? 'animate-spin border-t-amber-500' : mode === 'IDLE' ? 'animate-spin border-t-blue-500' : ''}`} style={{animationDuration: mode === 'SCANNING' ? '1s' : '4s'}}></div>
                            
                            {/* Ícone Central */}
                            <div className="w-12 h-12 bg-gray-800/50 rounded-full flex items-center justify-center backdrop-blur-sm border border-gray-700 z-10">
                                <i className={`fas fa-radar text-xl ${getStatusColor()}`}></i>
                            </div>
                            
                            {/* Ondas de Pulso */}
                            {mode === 'SIGNAL' && <div className="pulse-ring w-full h-full border-green-500"></div>}
                            {mode === 'SCANNING' && <div className="pulse-ring w-full h-full border-amber-500"></div>}
                        </div>
                    </div>
                </div>
            );
        };

        function CountdownTimer() {
            const [countdown, setCountdown] = useState(60 - new Date().getSeconds());
            useEffect(() => {
                const timer = setInterval(() => setCountdown(60 - new Date().getSeconds()), 1000);
                return () => clearInterval(timer);
            }, []);
            return (
                <div className="text-center bg-gray-800/50 rounded-lg p-2">
                    <p className="text-[10px] uppercase tracking-wider text-gray-400 mb-1">Próxima Vela</p>
                    <p className="text-xl font-bold text-amber-400 font-mono">{String(countdown).padStart(2, '0')}s</p>
                </div>
            );
        }

        const NavLink = ({ viewName, currentView, setView, icon, text, isMobile = false }) => {
            const isActive = currentView === viewName;
            return (
                <button 
                    onClick={() => setView(viewName)} 
                    className={`flex items-center transition-all duration-200 ${
                        isMobile 
                        ? `flex-1 flex-col py-3 text-[10px] ${isActive ? 'text-amber-400' : 'text-gray-500 hover:text-gray-300'}` 
                        : `w-full space-x-3 px-4 py-3 rounded-lg text-sm font-medium ${isActive ? 'nav-link-active shadow-lg shadow-amber-500/20' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`
                    }`}
                >
                    <i className={`fa-solid ${icon} text-lg ${isMobile ? 'mb-1 text-xl' : 'w-6 text-center'}`}></i>
                    <span className={isMobile ? '' : ''}>{text}</span>
                </button>
            );
        };

        // --- Páginas ---

        function LoginPage({ onLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const { addToast } = useToast();

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) addToast(error.message, 'error');
                else if (data.user) {
                    addToast('Bem-vindo de volta!', 'success');
                    onLogin(data.user);
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-gray-900 to-black">
                    <div className="w-full max-w-md p-8 glass-card rounded-2xl shadow-2xl">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-amber-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i className="fas fa-robot text-3xl text-amber-400"></i>
                            </div>
                            <h2 className="text-2xl font-bold text-white">Acesso Admin</h2>
                            <p className="text-gray-400 text-sm mt-1">Marombiew Bot Control</p>
                        </div>
                        <form className="space-y-5" onSubmit={handleLogin}>
                            <div><input type="email" required className="form-input w-full px-4 py-3 rounded-xl" placeholder="admin@exemplo.com" value={email} onChange={e => setEmail(e.target.value)} /></div>
                            <div><input type="password" required className="form-input w-full px-4 py-3 rounded-xl" placeholder="••••••••" value={password} onChange={e => setPassword(e.target.value)} /></div>
                            <button type="submit" className="btn bg-amber-500 hover:bg-amber-600 w-full py-3 rounded-xl text-white shadow-lg shadow-amber-500/20 flex justify-center items-center gap-2" disabled={loading}>
                                {loading && <div className="spinner w-4 h-4 border-2"></div>}
                                {loading ? 'Autenticando...' : 'Entrar no Sistema'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function HomeView() {
            const [signals, setSignals] = useState([]);
            const [balanceInfo, setBalanceInfo] = useState({ current: 0, initial: 0 });
            const [botStatus, setBotStatus] = useState('PAUSED'); // Novo estado
            const [isResetting, setIsResetting] = useState(false);
            const [lastLog, setLastLog] = useState(null); 
            const { addToast } = useToast();

            const scores = useMemo(() => {
                const wins = signals.filter(s => s.result === 'WIN').length;
                const losses = signals.filter(s => s.result === 'LOSS').length;
                return { wins, losses, total: wins + losses };
            }, [signals]);

            const assertividade = scores.total > 0 ? ((scores.wins / scores.total) * 100).toFixed(0) : 0;
            const profit = balanceInfo.current - balanceInfo.initial;

            const handleResetScores = async () => {
                if (!confirm("Confirmar reset do histórico diário?")) return;
                setIsResetting(true);
                const { error } = await supabaseClient.rpc('reset_daily_stats');
                if (error) addToast("Erro ao zerar: " + error.message, 'error');
                else {
                    setSignals([]);
                    addToast("Placar zerado com sucesso", 'success');
                }
                setIsResetting(false);
            };
            
            useEffect(() => {
                const fetchData = async () => {
                    const { data: sData } = await supabaseClient.from('trade_signals').select('*').order('created_at', { ascending: false }).limit(50);
                    if (sData) setSignals(sData);
                    
                    const { data: cData } = await supabaseClient.from('bot_config').select('current_balance, daily_initial_balance, status').eq('id', 1).single();
                    if (cData) {
                        setBalanceInfo({ current: cData.current_balance || 0, initial: cData.daily_initial_balance || 0 });
                        setBotStatus(cData.status || 'PAUSED');
                    }
                };
                fetchData();

                const subSignals = supabaseClient.channel('signals_realtime')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'trade_signals' }, (payload) => {
                        if (payload.eventType === 'INSERT') setSignals(prev => [payload.new, ...prev]);
                        else if (payload.eventType === 'UPDATE') setSignals(prev => prev.map(s => s.id === payload.new.id ? payload.new : s));
                    }).subscribe();

                const subConfig = supabaseClient.channel('config_realtime')
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'bot_config' }, (payload) => {
                        setBalanceInfo({ current: payload.new.current_balance || 0, initial: payload.new.daily_initial_balance || 0 });
                        setBotStatus(payload.new.status || 'PAUSED');
                    }).subscribe();

                // Assinar logs para o Scanner
                const subLogs = supabaseClient.channel('logs_home')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'logs' }, (payload) => {
                        setLastLog(payload.new);
                    }).subscribe();

                return () => { 
                    supabaseClient.removeChannel(subSignals); 
                    supabaseClient.removeChannel(subConfig); 
                    supabaseClient.removeChannel(subLogs);
                };
            }, []);

            return (
                <div className="space-y-6 pb-20 md:pb-0">
                    <div className="flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-bold text-white">Dashboard</h1>
                            <p className="text-xs text-gray-400">Visão geral do dia</p>
                        </div>
                        <button onClick={handleResetScores} className="btn bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white px-3 py-2 rounded-lg text-xs flex items-center gap-2" disabled={isResetting}>
                            <i className={`fas fa-undo ${isResetting ? 'fa-spin' : ''}`}></i> Reset
                        </button>
                    </div>
                    
                    {/* WIDGET DO SCANNER (Passamos o status real) */}
                    <ScannerWidget lastLog={lastLog} botStatus={botStatus} />

                    {/* Cards Topo */}
                    <div className="grid grid-cols-2 gap-4">
                        <div className="glass-card p-4 rounded-xl relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-2 opacity-10"><i className="fas fa-wallet text-6xl"></i></div>
                            <p className="text-xs text-gray-400 font-medium">SALDO ATUAL</p>
                            <p className="text-2xl font-bold text-white mt-1">${Number(balanceInfo.current).toFixed(2)}</p>
                        </div>
                        <div className="glass-card p-4 rounded-xl relative overflow-hidden">
                            <div className={`absolute top-0 right-0 p-2 opacity-10 ${profit >= 0 ? 'text-green-500' : 'text-red-500'}`}><i className="fas fa-chart-line text-6xl"></i></div>
                            <p className="text-xs text-gray-400 font-medium">RESULTADO DO DIA</p>
                            <p className={`text-2xl font-bold mt-1 ${profit >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                {profit >= 0 ? '+' : ''}${profit.toFixed(2)}
                            </p>
                        </div>
                    </div>

                    {/* Placar */}
                    <div className="glass-card p-4 rounded-xl">
                        <div className="flex justify-between items-center text-center divide-x divide-gray-700">
                            <div className="flex-1 px-2">
                                <p className="text-xs text-green-500 font-bold mb-1">WINS</p>
                                <span className="text-2xl font-bold text-white">{scores.wins}</span>
                            </div>
                            <div className="flex-1 px-2">
                                <p className="text-xs text-red-500 font-bold mb-1">LOSS</p>
                                <span className="text-2xl font-bold text-white">{scores.losses}</span>
                            </div>
                            <div className="flex-1 px-2">
                                <p className="text-xs text-blue-400 font-bold mb-1">ASSERT.</p>
                                <span className="text-2xl font-bold text-white">{assertividade}%</span>
                            </div>
                            <div className="flex-1 px-2">
                                <CountdownTimer />
                            </div>
                        </div>
                    </div>
                    
                    {/* Lista de Sinais */}
                    <div>
                        <h2 className="text-sm font-bold text-gray-400 mb-3 uppercase tracking-wide">Últimos Sinais</h2>
                        <div className="space-y-3">
                            {signals.length > 0 ? signals.map(signal => (
                                <div key={signal.id} className="glass-card p-3 rounded-lg flex items-center justify-between border-l-4" style={{borderLeftColor: signal.direction === 'call' ? '#22c55e' : '#ef4444'}}>
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center ${signal.direction === 'call' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                            <i className={`fas fa-arrow-${signal.direction === 'call' ? 'up' : 'down'}`}></i>
                                        </div>
                                        <div>
                                            <p className="font-bold text-white text-sm">{signal.pair}</p>
                                            <p className="text-[10px] text-gray-400">{new Date(signal.created_at).toLocaleTimeString()} • {signal.strategy}</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        {signal.result === 'WIN' && <span className="text-green-400 font-bold text-sm"><i className="fas fa-check mr-1"></i>WIN</span>}
                                        {signal.result === 'LOSS' && <span className="text-red-400 font-bold text-sm"><i className="fas fa-times mr-1"></i>LOSS</span>}
                                        {signal.result === 'DRAW' && <span className="text-gray-400 font-bold text-sm">EMPATE</span>}
                                        {(!signal.result || signal.result === 'PENDING') && <span className="text-amber-400 text-xs font-medium animate-pulse"><i className="fas fa-circle-notch fa-spin mr-1"></i>Em curso</span>}
                                        {signal.martingale_level > 0 && <span className="block text-[9px] text-orange-400">Gale {signal.martingale_level}</span>}
                                    </div>
                                </div>
                            )) : (
                                <div className="text-center py-10 glass-card rounded-xl">
                                    <i className="fas fa-radar text-gray-600 text-4xl mb-3"></i>
                                    <p className="text-gray-500 text-sm">A aguardar sinais...</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function StrategiesView() {
            const [config, setConfig] = useState(null);
            const [catalog, setCatalog] = useState([]);
            const { addToast } = useToast();
            const [saving, setSaving] = useState(false);

            useEffect(() => {
                const fetch = async () => {
                    const { data: cfg } = await supabaseClient.from('bot_config').select('min_win_rate').eq('id', 1).single();
                    if (cfg) setConfig(cfg);
                    const { data: cat } = await supabaseClient.from('cataloged_assets').select('*').order('win_rate', { ascending: false });
                    if (cat) setCatalog(cat);
                };
                fetch();
            }, []);

            const saveWinRate = async () => {
                setSaving(true);
                const { error } = await supabaseClient.from('bot_config').update({ min_win_rate: config.min_win_rate }).eq('id', 1);
                if (error) addToast("Erro ao salvar: " + error.message, 'error');
                else addToast("Assertividade mínima atualizada!", 'success');
                setSaving(false);
            };

            if (!config) return <div className="flex justify-center p-10"><div className="spinner"></div></div>;

            return (
                <div className="space-y-6 pb-20 md:pb-0">
                    <h1 className="text-2xl font-bold text-white">Catalogador</h1>
                    
                    <div className="glass-card p-5 rounded-xl">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-sm font-bold text-gray-300">Assertividade Mínima</h2>
                            <span className="text-amber-400 font-bold text-xl">{config.min_win_rate}%</span>
                        </div>
                        <input type="range" min="50" max="95" value={config.min_win_rate} onChange={e => setConfig({...config, min_win_rate: parseInt(e.target.value)})} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-amber-500" />
                        <button onClick={saveWinRate} className="btn bg-gray-700 hover:bg-gray-600 w-full mt-4 py-2 rounded-lg text-sm text-white" disabled={saving}>
                            {saving ? 'Salvando...' : 'Atualizar Filtro'}
                        </button>
                    </div>

                    <div className="space-y-3">
                        <h2 className="text-sm font-bold text-gray-400 uppercase tracking-wide">Melhores Ativos (M5/M1)</h2>
                        {catalog.length > 0 ? catalog.map(asset => (
                            <div key={asset.pair} className="glass-card p-3 rounded-lg flex items-center justify-between">
                                <div>
                                    <p className="font-bold text-white">{asset.pair}</p>
                                    <p className="text-xs text-gray-400">{asset.best_strategy} • <span className="text-green-400">{asset.wins}W</span> / <span className="text-red-400">{asset.losses}L</span></p>
                                </div>
                                <div className={`text-lg font-bold ${asset.win_rate >= 80 ? 'text-green-400' : asset.win_rate >= 60 ? 'text-amber-400' : 'text-red-400'}`}>
                                    {asset.win_rate.toFixed(1)}%
                                </div>
                            </div>
                        )) : (
                            <p className="text-center text-gray-500 py-10">Nenhum dado catalogado ainda.</p>
                        )}
                    </div>
                </div>
            );
        }

        function SettingsView() {
            const [config, setConfig] = useState(null);
            const { addToast } = useToast();
            const [saving, setSaving] = useState(false);
            
            const debounceRef = useRef(null);

            useEffect(() => {
                const fetch = async () => {
                    const { data } = await supabaseClient.from('bot_config').select('*').eq('id', 1).single();
                    if (data) setConfig(data);
                };
                fetch();
            }, []);

            const updateField = (field, value) => {
                setConfig(prev => ({ ...prev, [field]: value }));
            };

            const toggleBotStatus = async () => {
                const newStatus = config.status === 'RUNNING' ? 'PAUSED' : 'RUNNING';
                if (newStatus === 'RUNNING') {
                    if (!confirm("Iniciar o bot irá resetar o placar diário. Continuar?")) return;
                    await supabaseClient.rpc('reset_daily_stats');
                }
                const { error } = await supabaseClient.from('bot_config').update({ status: newStatus }).eq('id', 1);
                if (error) addToast("Erro: " + error.message, 'error');
                else {
                    setConfig(prev => ({ ...prev, status: newStatus }));
                    addToast(`Bot ${newStatus === 'RUNNING' ? 'INICIADO' : 'PAUSADO'}`, newStatus === 'RUNNING' ? 'success' : 'info');
                }
            };

            const saveSettings = async () => {
                setSaving(true);
                const { error } = await supabaseClient.from('bot_config').update(config).eq('id', 1);
                if (error) addToast("Erro ao salvar: " + error.message, 'error');
                else addToast("Configurações atualizadas!", 'success');
                setSaving(false);
            };

            if (!config) return <div className="flex justify-center p-10"><div className="spinner"></div></div>;

            return (
                <div className="space-y-6 pb-20 md:pb-0">
                    <h1 className="text-2xl font-bold text-white">Configurações</h1>

                    {/* Status Card */}
                    <div className="glass-card p-5 rounded-xl flex items-center justify-between border border-gray-700">
                        <div>
                            <p className="text-sm text-gray-400 font-medium">STATUS DO SISTEMA</p>
                            <p className={`text-xl font-bold ${config.status === 'RUNNING' ? 'text-green-400' : 'text-amber-400'}`}>
                                {config.status === 'RUNNING' ? 'ONLINE' : 'PAUSADO'}
                            </p>
                        </div>
                        <button onClick={toggleBotStatus} className={`btn w-12 h-12 rounded-full flex items-center justify-center shadow-lg ${config.status === 'RUNNING' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`}>
                            <i className={`fas ${config.status === 'RUNNING' ? 'fa-pause' : 'fa-play'} text-white text-lg`}></i>
                        </button>
                    </div>

                    <div className="glass-card p-6 rounded-xl space-y-6">
                        <h2 className="text-sm font-bold text-amber-400 uppercase tracking-wide mb-4">Gerenciamento de Risco</h2>
                        
                        <div>
                            <label className="block text-xs text-gray-400 mb-2 uppercase">Modo de Stop</label>
                            <div className="grid grid-cols-2 gap-2 bg-gray-900 p-1 rounded-lg">
                                <button onClick={() => updateField('stop_mode', 'operations')} className={`py-2 text-xs font-bold rounded-md transition-all ${config.stop_mode === 'operations' ? 'bg-gray-700 text-white shadow' : 'text-gray-500 hover:text-gray-300'}`}>POR SINAIS</button>
                                <button onClick={() => updateField('stop_mode', 'percentage')} className={`py-2 text-xs font-bold rounded-md transition-all ${config.stop_mode === 'percentage' ? 'bg-gray-700 text-white shadow' : 'text-gray-500 hover:text-gray-300'}`}>PORCENTAGEM</button>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs text-gray-400 mb-1">Stop Win ({config.stop_mode === 'operations' ? 'Qtd' : '%'})</label>
                                <input type="number" className="form-input w-full p-3 rounded-lg text-green-400 font-bold" value={config.stop_mode === 'operations' ? config.stop_win : config.stop_win_percent} onChange={e => updateField(config.stop_mode === 'operations' ? 'stop_win' : 'stop_win_percent', Number(e.target.value))} />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-400 mb-1">Stop Loss ({config.stop_mode === 'operations' ? 'Qtd' : '%'})</label>
                                <input type="number" className="form-input w-full p-3 rounded-lg text-red-400 font-bold" value={config.stop_mode === 'operations' ? config.stop_loss : config.stop_loss_percent} onChange={e => updateField(config.stop_mode === 'operations' ? 'stop_loss' : 'stop_loss_percent', Number(e.target.value))} />
                            </div>
                        </div>
                    </div>

                    <div className="glass-card p-6 rounded-xl space-y-6">
                        <div className="flex justify-between items-center">
                            <h2 className="text-sm font-bold text-amber-400 uppercase tracking-wide">Estratégia & Martingale</h2>
                            <label className="flex items-center cursor-pointer">
                                <span className="text-xs mr-2 text-gray-400">{config.use_martingale ? 'Gale ON' : 'Gale OFF'}</span>
                                <div className="relative">
                                    <input type="checkbox" className="hidden" checked={config.use_martingale} onChange={() => updateField('use_martingale', !config.use_martingale)} />
                                    <div className="toggle-bg w-10 h-6 bg-gray-700 rounded-full shadow-inner"></div>
                                </div>
                            </label>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs text-gray-400 mb-1">Valor Entrada ($)</label>
                                <input type="number" className="form-input w-full p-3 rounded-lg font-bold" value={config.entry_value} onChange={e => updateField('entry_value', Number(e.target.value))} />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-400 mb-1">Conta</label>
                                <select className="form-select w-full p-3 rounded-lg font-bold" value={config.account_type} onChange={e => updateField('account_type', e.target.value)}>
                                    <option value="PRACTICE">DEMO</option>
                                    <option value="REAL">REAL</option>
                                </select>
                            </div>
                        </div>

                        {config.use_martingale && (
                            <div className="grid grid-cols-2 gap-4 p-4 bg-gray-900/50 rounded-lg border border-gray-800">
                                <div>
                                    <label className="block text-xs text-gray-500 mb-1">Níveis</label>
                                    <input type="number" className="form-input w-full p-2 rounded text-sm" value={config.martingale_levels} onChange={e => updateField('martingale_levels', Number(e.target.value))} />
                                </div>
                                <div>
                                    <label className="block text-xs text-gray-500 mb-1">Fator</label>
                                    <input type="number" step="0.1" className="form-input w-full p-2 rounded text-sm" value={config.martingale_factor} onChange={e => updateField('martingale_factor', Number(e.target.value))} />
                                </div>
                            </div>
                        )}
                    </div>

                    <button onClick={saveSettings} className="btn w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-amber-500/20 flex justify-center items-center gap-2" disabled={saving}>
                        {saving ? <div className="spinner w-5 h-5 border-white"></div> : <i className="fas fa-save"></i>}
                        {saving ? 'Salvando...' : 'Salvar Alterações'}
                    </button>
                </div>
            );
        }

        function LogsView() {
            const [logs, setLogs] = useState([]);
            const endRef = useRef(null);

            useEffect(() => {
                const fetch = async () => {
                    const { data } = await supabaseClient.from('logs').select('*').order('created_at', { ascending: false }).limit(100);
                    if (data) setLogs(data.reverse());
                };
                fetch();
                const sub = supabaseClient.channel('logs_rt').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'logs' }, payload => {
                    setLogs(prev => [...prev.slice(-99), payload.new]);
                }).subscribe();
                return () => supabaseClient.removeChannel(sub);
            }, []);

            useEffect(() => { endRef.current?.scrollIntoView({ behavior: "smooth" }); }, [logs]);

            return (
                <div className="flex flex-col h-full pb-20 md:pb-0">
                    <h1 className="text-2xl font-bold text-white mb-4">Terminal de Logs</h1>
                    <div className="flex-1 glass-card rounded-xl p-4 overflow-y-auto font-mono text-xs space-y-2 border border-gray-700 bg-black/40">
                        {logs.length === 0 && <p className="text-gray-500 text-center mt-10">Aguardando logs do sistema...</p>}
                        {logs.map(log => (
                            <div key={log.id} className="flex gap-2">
                                <span className="text-gray-500 shrink-0">[{new Date(log.created_at).toLocaleTimeString()}]</span>
                                <span className={`${log.level === 'ERROR' ? 'text-red-400' : log.level === 'WARNING' ? 'text-amber-400' : log.level === 'SUCCESS' ? 'text-green-400' : 'text-blue-300'}`}>
                                    {log.level}:
                                </span>
                                <span className="text-gray-300 break-all">{log.message}</span>
                            </div>
                        ))}
                        <div ref={endRef}></div>
                    </div>
                </div>
            );
        }

        function App() {
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home');

            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setLoading(false);
                });
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => setSession(session));
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                if (!loading) {
                    const splash = document.getElementById('static-splash');
                    if (splash) {
                        splash.style.opacity = '0';
                        setTimeout(() => splash.remove(), 400);
                    }
                }
            }, [loading]);

            if (loading) return null;
            if (!session) return (
                <ToastProvider>
                    <LoginPage onLogin={() => {}} />
                </ToastProvider>
            );

            const handleLogout = () => supabaseClient.auth.signOut();

            return (
                <ToastProvider>
                    <div className="flex h-screen bg-bg-dark text-text-primary overflow-hidden">
                        {/* Sidebar Desktop */}
                        <aside className="hidden md:flex w-64 bg-bg-medium border-r border-border-color flex-col">
                            <div className="h-20 flex items-center px-6 border-b border-gray-800">
                                <i className="fas fa-robot text-amber-400 text-2xl mr-3"></i>
                                <span className="font-bold text-lg tracking-wider">MAROMBIEW</span>
                            </div>
                            <nav className="flex-1 p-4 space-y-2">
                                <NavLink viewName="home" currentView={view} setView={setView} icon="fa-chart-pie" text="Dashboard" />
                                <NavLink viewName="strategies" currentView={view} setView={setView} icon="fa-layer-group" text="Estratégias" />
                                <NavLink viewName="settings" currentView={view} setView={setView} icon="fa-sliders" text="Configurações" />
                                <NavLink viewName="logs" currentView={view} setView={setView} icon="fa-terminal" text="Logs do Sistema" />
                            </nav>
                            <div className="p-4 border-t border-gray-800">
                                <button onClick={handleLogout} className="w-full flex items-center px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 rounded-lg transition-colors">
                                    <i className="fa-solid fa-right-from-bracket w-6"></i> Sair
                                </button>
                            </div>
                        </aside>

                        {/* Conteúdo Principal */}
                        <main className="flex-1 flex flex-col h-full overflow-hidden relative">
                            <div className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
                                {view === 'home' && <HomeView />}
                                {view === 'strategies' && <StrategiesView />}
                                {view === 'settings' && <SettingsView />}
                                {view === 'logs' && <LogsView />}
                            </div>
                        </main>

                        {/* Menu Mobile (Fixo em baixo) */}
                        <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-bg-medium/95 backdrop-blur-lg border-t border-gray-800 flex justify-around px-2 pb-safe z-40 h-16">
                            <NavLink viewName="home" currentView={view} setView={setView} icon="fa-chart-pie" text="Dash" isMobile={true} />
                            <NavLink viewName="strategies" currentView={view} setView={setView} icon="fa-layer-group" text="Estrat." isMobile={true} />
                            <div className="relative -top-5">
                                <button onClick={() => setView('settings')} className={`w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-4 border-bg-dark ${view === 'settings' ? 'bg-amber-500 text-white' : 'bg-gray-700 text-gray-300'}`}>
                                    <i className="fas fa-sliders text-xl"></i>
                                </button>
                            </div>
                            <NavLink viewName="logs" currentView={view} setView={setView} icon="fa-terminal" text="Logs" isMobile={true} />
                            <button onClick={handleLogout} className="flex-1 flex flex-col items-center justify-center py-2 text-[10px] text-gray-500">
                                <i className="fa-solid fa-power-off text-lg mb-1"></i>
                                <span>Sair</span>
                            </button>
                        </nav>
                    </div>
                </ToastProvider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
