<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MAROMBIEW BOT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0a0a0a; color: #e5e7eb; font-family: 'Poppins', sans-serif; }
        .glass-card { background: rgba(17, 24, 39, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .form-input { background-color: #1f2937; border-color: #374151; }
        .btn-primary { background-color: #0d9488; }
        .btn-primary:hover { background-color: #14b8a6; }
        .nav-link-active { background-color: #14b8a6; color: white; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        @keyframes card-enter { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .card-enter-animation { animation: card-enter 0.4s ease-out forwards; }
        .timer-border-wrapper { position: absolute; top: -2px; right: -2px; bottom: -2px; left: -2px; border-radius: 1.125rem; z-index: 0; background: var(--gradient); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, Component } = React;
        const { createClient } = supabase;

        // --- INFORMAÇÕES DE CONEXÃO COM O SUPABASE ---
        const SUPABASE_URL = 'https://ioduahwknfsktujthfyc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZHVhaHdrbmZza3R1anRoZnljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMDc0NDcsImV4cCI6MjA2Njg4MzQ0N30.96f8wZO6SvABKFMWjIiw1pSugAB4Isldj7yxLcLJRSE';
        const WEBSOCKET_URL = 'wss://botexnova.marombiew.com';

        let supabaseClient;
        let supabaseInitializationError = null;

        if (SUPABASE_URL.includes('SEU_URL') || SUPABASE_ANON_KEY.includes('SUA_CHAVE')) {
            supabaseInitializationError = "As credenciais do Supabase não foram definidas no ficheiro HTML. Edite o ficheiro e substitua 'SEU_URL_DO_SUPABASE' e 'SUA_CHAVE_ANON_DO_SUPABASE' pelas suas chaves reais.";
        } else {
            try {
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } catch (e) {
                supabaseInitializationError = `Erro ao inicializar o Supabase: ${e.message}`;
            }
        }

        // --- Componentes ---

        function LoginPage({ onLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) setError(error.message);
                else if (data.user) onLogin(data.user);
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900">
                    <div className="w-full max-w-md p-8 space-y-8 glass-card rounded-xl">
                        <div><h2 className="mt-6 text-center text-3xl font-extrabold text-white">Login</h2></div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div className="rounded-md shadow-sm -space-y-px">
                                <div><input type="email" required className="form-input appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 text-gray-300 rounded-t-md focus:outline-none focus:ring-teal-500 focus:border-teal-500" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} /></div>
                                <div><input type="password" required className="form-input appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 text-gray-300 rounded-b-md focus:outline-none focus:ring-teal-500 focus:border-teal-500" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} /></div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div><button type="submit" className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500" disabled={loading}>{loading ? 'A entrar...' : 'Entrar'}</button></div>
                        </form>
                    </div>
                </div>
            );
        }
        
        function AdminDashboard() {
            const [view, setView] = useState('bot_control');
            const handleLogout = async () => { await supabaseClient.auth.signOut(); window.location.reload(); };

            return (
                <div className="flex h-screen bg-gray-900">
                    <aside className="w-64 bg-gray-800 text-white flex flex-col">
                        <div className="h-16 flex items-center justify-center text-2xl font-bold border-b border-gray-700">Admin</div>
                        <nav className="flex-1 px-2 py-4 space-y-2">
                            <a href="#" onClick={() => setView('bot_control')} className={`block px-4 py-2 rounded-md ${view === 'bot_control' ? 'nav-link-active' : ''}`}>Controlo do Bot</a>
                            <a href="#" onClick={() => setView('user_management')} className={`block px-4 py-2 rounded-md ${view === 'user_management' ? 'nav-link-active' : ''}`}>Gestão de Alunos</a>
                        </nav>
                        <div className="p-4 border-t border-gray-700"><button onClick={handleLogout} className="w-full text-left px-4 py-2 rounded-md hover:bg-red-500">Sair</button></div>
                    </aside>
                    <main className="flex-1 p-10 overflow-y-auto">
                        {view === 'bot_control' && <BotControl />}
                        {view === 'user_management' && <UserManagement />}
                    </main>
                </div>
            );
        }
        
        function BotControl() {
            const [botStatus, setBotStatus] = useState('PAUSED');
            const [params, setParams] = useState('');
            const [loading, setLoading] = useState(false);

            const fetchConfig = useCallback(async () => {
                const { data } = await supabaseClient.table('bot_config').select('*').eq('id', 1).single();
                if (data) {
                    setBotStatus(data.status);
                    setParams(JSON.stringify(data.params, null, 2));
                }
            }, []);

            useEffect(() => { fetchConfig(); }, [fetchConfig]);

            const handleStatusChange = async (newStatus) => {
                setLoading(true);
                await supabaseClient.table('bot_config').update({ status: newStatus }).eq('id', 1);
                fetchConfig();
                setLoading(false);
            };

            const handleParamsSave = async () => {
                try {
                    const parsedParams = JSON.parse(params);
                    setLoading(true);
                    await supabaseClient.table('bot_config').update({ params: parsedParams }).eq('id', 1);
                    alert('Parâmetros guardados com sucesso!');
                    setLoading(false);
                } catch (e) { alert('Erro: JSON inválido!'); }
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold text-white mb-6">Controlo do Bot</h1>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="glass-card p-6 rounded-xl">
                            <h2 className="text-xl font-bold mb-4">Estado do Bot</h2>
                            <p className="mb-4">Estado atual: <span className={`font-bold ${botStatus === 'RUNNING' ? 'text-green-400' : 'text-amber-400'}`}>{botStatus}</span></p>
                            <div className="flex gap-4">
                                <button onClick={() => handleStatusChange('RUNNING')} className="btn-primary px-4 py-2 rounded-md disabled:opacity-50" disabled={loading || botStatus === 'RUNNING'}>Iniciar Bot</button>
                                <button onClick={() => handleStatusChange('PAUSED')} className="bg-amber-500 hover:bg-amber-600 px-4 py-2 rounded-md disabled:opacity-50" disabled={loading || botStatus === 'PAUSED'}>Pausar Bot</button>
                            </div>
                        </div>
                         <div className="glass-card p-6 rounded-xl">
                            <h2 className="text-xl font-bold mb-4">Parâmetros das Estratégias</h2>
                            <textarea value={params} onChange={(e) => setParams(e.target.value)} className="form-input w-full h-64 font-mono text-sm p-2 rounded-md"></textarea>
                            <button onClick={handleParamsSave} className="mt-4 btn-primary w-full py-2 rounded-md disabled:opacity-50" disabled={loading}>Guardar Parâmetros</button>
                        </div>
                    </div>
                </div>
            );
        }

        function UserManagement() {
            const [users, setUsers] = useState([]);
            const fetchUsers = useCallback(async () => {
                const { data } = await supabaseClient.from('profiles').select(`id, email, role, subscriptions ( status, expires_at )`);
                if(data) setUsers(data);
            }, []);

            useEffect(() => { fetchUsers(); }, [fetchUsers]);
            
            const handleSubscriptionChange = async (userId, newStatus, newExpiry) => {
                 const { data } = await supabaseClient.from('subscriptions').select('user_id').eq('user_id', userId).single();
                if (data) await supabaseClient.from('subscriptions').update({ status: newStatus, expires_at: newExpiry }).eq('user_id', userId);
                else await supabaseClient.from('subscriptions').insert({ user_id: userId, status: newStatus, expires_at: newExpiry });
                fetchUsers();
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold text-white mb-6">Gestão de Alunos</h1>
                    <div className="glass-card rounded-xl overflow-hidden">
                        <table className="min-w-full">
                            <thead className="bg-gray-800">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Email</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Estado</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Expira em</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-700">
                                {users.filter(u => u.role === 'user').map(user => {
                                    const sub = user.subscriptions[0] || {};
                                    const expiryDate = sub.expires_at ? new Date(sub.expires_at).toISOString().split('T')[0] : '';
                                    return (
                                        <tr key={user.id}>
                                            <td className="px-6 py-4 whitespace-nowrap">{user.email}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">{sub.status || 'inactive'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">{expiryDate}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <button onClick={() => {
                                                    const newDate = prompt("Nova data de expiração (YYYY-MM-DD):", expiryDate);
                                                    if(newDate) handleSubscriptionChange(user.id, 'active', newDate);
                                                }} className="text-teal-400 hover:text-teal-300">Editar</button>
                                                <button onClick={() => handleSubscriptionChange(user.id, 'inactive', sub.expires_at)} className="text-red-400 hover:text-red-300">Desativar</button>
                                            </td>
                                        </tr>
                                    )
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- Componentes do Cliente (Recriados e Corrigidos) ---

        const ClientDashboard = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('home');
            const [signals, setSignals] = useState([]);
            const [scoreboard, setScoreboard] = useState({ wins: 0, losses: 0, gale_wins: 0 });
            const [liveAnalysis, setLiveAnalysis] = useState({});
            const [isConnected, setIsConnected] = useState(false);
            const socketRef = useRef(null);
            
            const subscription = userProfile.subscriptions[0] || {};
            const isSubscriptionActive = subscription.status === 'active' && new Date(subscription.expires_at) > new Date();

            const handleMessage = useCallback((message) => {
                if (!message || !message.type) return;
                switch (message.type) {
                    case 'init':
                        const initialData = message.data || {};
                        setScoreboard(initialData.placar || { wins: 0, losses: 0, gale_wins: 0 });
                        setSignals((initialData.signals || []).sort((a,b) => (b.entry_time || "").localeCompare(a.entry_time || "")));
                        break;
                    case 'live_analysis': setLiveAnalysis(message.data); break;
                    case 'signal': setSignals(prev => [message, ...prev]); break;
                    case 'result':
                        if (message.placar) setScoreboard(message.placar);
                        setSignals(prev => prev.map(s => s.signal_id === message.signal_id ? { ...s, result: message.result } : s));
                        break;
                    case 'gale':
                         setSignals(prev => prev.map(s => s.signal_id === message.signal_id ? { ...s, gale_level: message.gale_level } : s));
                        break;
                }
            }, []);

            const connect = useCallback(() => {
                if (socketRef.current && socketRef.current.readyState === WebSocket.OPEN) return;
                socketRef.current = new WebSocket(WEBSOCKET_URL);
                socketRef.current.onmessage = (event) => { try { handleMessage(JSON.parse(event.data)); } catch (e) { console.error('Failed to parse message:', event.data, e)} };
                socketRef.current.onopen = () => setIsConnected(true);
                socketRef.current.onclose = () => { setIsConnected(false); setTimeout(connect, 5000); };
                socketRef.current.onerror = () => setIsConnected(false);
            }, [handleMessage]);

            useEffect(() => {
                if (isSubscriptionActive) {
                    connect();
                    return () => { if (socketRef.current) socketRef.current.close(); };
                }
            }, [connect, isSubscriptionActive]);

            const renderView = () => {
                if (!isSubscriptionActive) {
                    return (
                        <div className="glass-card rounded-xl p-8 text-center card-enter-animation">
                            <i className="fa-solid fa-lock text-4xl text-amber-400 mb-4"></i>
                            <h3 className="text-xl font-bold">Acesso Expirado ou Inativo</h3>
                            <p className="text-gray-400 mt-2">A sua subscrição não está ativa. Por favor, contacte o suporte.</p>
                        </div>
                    );
                }
                switch(activeTab) {
                    case 'reports': return <ReportsView signals={signals} />;
                    case 'home':
                    default: 
                        return <HomeView signals={signals} liveAnalysis={liveAnalysis} />;
                }
            };
            
            return (
              <div className="h-screen w-screen flex flex-col p-4 sm:p-6 lg:p-8 gap-6">
                  <div className="flex-shrink-0">
                    <Header isConnected={isConnected} />
                    <Scoreboard scoreboard={scoreboard} />
                  </div>
                  <main className="flex-grow overflow-y-auto pb-20 lg:pb-0 no-scrollbar">{renderView()}</main>
                  <div className="fixed bottom-0 left-0 right-0 lg:static lg:order-first z-50">
                      <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
                  </div>
              </div>
            );
        }

        const HomeView = ({ signals, liveAnalysis }) => {
            const latestActiveSignalId = useMemo(() => {
                const activeSignals = signals.filter(s => !s.result);
                return activeSignals.length > 0 ? activeSignals[0].signal_id : null;
            }, [signals]);

            return (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <LiveAnalysisCard analysis={liveAnalysis} showTimer={!latestActiveSignalId} />
                        {signals.map(signal => <SignalCard key={`${signal.signal_id}-${signal.result}`} signal={signal} isLatestActive={signal.signal_id === latestActiveSignalId} />)}
                    </div>);
        }
        const ReportsView = ({ signals }) => {
            const completedSignals = useMemo(() => signals.filter(s => s.result && s.result !== 'DRAW'), [signals]);
            const reports = useMemo(() => {
                if (completedSignals.length === 0) return { strategyReport: {}, pairReport: {} };
                const strategyReport = {}; const pairReport = {};
                completedSignals.forEach(signal => {
                    if (!signal.strategy) return;
                    const isWin = signal.result === 'WIN';
                    if (!strategyReport[signal.strategy]) strategyReport[signal.strategy] = { wins: 0, losses: 0 };
                    if (isWin) strategyReport[signal.strategy].wins++; else strategyReport[signal.strategy].losses++;
                    if (!pairReport[signal.pair]) pairReport[signal.pair] = { wins: 0, losses: 0 };
                    if (isWin) pairReport[signal.pair].wins++; else pairReport[signal.pair].losses++;
                });
                return { strategyReport, pairReport };
            }, [completedSignals]);
            const ReportCard = ({ title, data }) => (<div className="glass-card rounded-xl p-6"><h3 className="text-xl font-bold mb-4">{title}</h3><div className="space-y-4">{Object.entries(data).length > 0 ? Object.entries(data).map(([key, value]) => {const total = value.wins + value.losses; const winRate = total > 0 ? ((value.wins / total) * 100).toFixed(1) : 0; return (<div key={key}><div className="flex justify-between items-center mb-1 text-sm"><span className="font-semibold">{key}</span><span className="font-mono text-gray-400">{value.wins}W / {value.losses}L</span></div><div className="w-full bg-gray-700 rounded-full h-2.5"><div className="bg-teal-500 h-2.5 rounded-full" style={{ width: `${winRate}%` }}></div></div><p className="text-xs text-right mt-1 text-teal-400">{winRate}% de Acerto</p></div>);}) : <p className="text-gray-500 text-center">Nenhum dado disponível.</p>}</div></div>);
            if (completedSignals.length === 0) {
                 return (<div className="glass-card rounded-xl p-8 text-center card-enter-animation"><i className="fa-solid fa-chart-simple text-4xl text-gray-500 mb-4"></i><h3 className="text-xl font-bold">Sem Dados de Relatório</h3><p className="text-gray-400 mt-2">Aguardando a finalização das primeiras operações.</p></div>);
            }
            return (<div className="grid grid-cols-1 md:grid-cols-2 gap-8 card-enter-animation"><ReportCard title="Performance por Estratégia" data={reports.strategyReport} /><ReportCard title="Performance por Par" data={reports.pairReport} /></div>);
        }
        const SignalCard = ({ signal, isLatestActive }) => {
            const isCall = signal.direction.toUpperCase() === 'BUY';
            const directionText = isCall ? 'CALL' : 'PUT';
            const directionColor = isCall ? 'text-green-400' : 'text-red-400';
            const directionIcon = isCall ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down';
            const ResultFooter = () => {
                if (!signal.result) return <div className="w-full mt-3 h-16"></div>;
                const isWin = signal.result === 'WIN'; const resultColor = isWin ? 'text-green-400' : 'text-red-400'; const resultIcon = isWin ? 'fa-solid fa-trophy' : 'fa-solid fa-shield-halved'; const resultBg = isWin ? 'bg-green-500/10 border-green-500/30' : 'bg-red-500/10 border-red-500/30';
                return (<div className={`w-full mt-3 h-16 flex items-center justify-center rounded-lg border ${resultBg}`}><div className="text-center"><p className={`text-xs ${resultColor}`}>RESULTADO</p><p className={`font-mono text-2xl font-bold ${resultColor} flex items-center justify-center gap-2`}><i className={resultIcon}></i><span>{signal.result}</span></p></div></div>);
            };
            return (<div className="glass-card rounded-2xl p-4 flex flex-col text-center card-enter-animation relative h-[240px]">
                {isLatestActive && !signal.result && <Timer />}
                <div className="relative z-10 flex flex-col h-full">
                    {signal.gale_level > 0 && <div className="absolute top-0 right-0 bg-amber-500 text-gray-900 text-xs font-bold px-2 py-0.5 rounded-full z-20">GALE {signal.gale_level}</div>}
                    <div className="flex justify-between items-center w-full mb-3">
                        <p className="font-bold text-xl text-white">{signal.pair}</p>
                        <p className="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded-md">{signal.strategy}</p>
                    </div>
                    <div className="flex-grow flex justify-between items-center gap-4">
                        <div className="flex flex-col justify-center h-full text-left">
                            <p className="text-xs text-gray-400">HORÁRIO</p>
                            <p className="font-mono text-3xl font-bold text-white my-1">{convertTimeToUserTimezone(signal.entry_time)}</p>
                            <div className={`font-semibold text-2xl ${directionColor}`}><i className={`fa-solid ${directionIcon} mr-1`}></i>{directionText}</div>
                        </div>
                        <div className="flex items-center justify-center gap-2">
                            <div className="w-10 h-24" dangerouslySetInnerHTML={{ __html: renderCandle(signal.previous_candle) }}></div>
                            <i className="fa-solid fa-chevron-right text-gray-500"></i>
                            <div className="w-10 h-24" dangerouslySetInnerHTML={{ __html: renderCandle(signal.candle) }}></div>
                        </div>
                    </div>
                    <ResultFooter />
                </div>
            </div>);
        };
        const Timer = () => {
            const [progress, setProgress] = useState(0);
            useEffect(() => {
                const updateTimer = () => setProgress(new Date().getSeconds());
                updateTimer();
                const intervalId = setInterval(updateTimer, 1000);
                return () => clearInterval(intervalId);
            }, []);
            const timerStyle = { '--gradient': `conic-gradient(#14b8a6 ${progress * 6}deg, rgba(255,255,255,0.1) 0deg)` };
            return <div className="timer-border-wrapper" style={timerStyle}></div>;
        };


        function App() {
            const [session, setSession] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if(supabaseInitializationError) {
                    setLoading(false);
                    return;
                }
                const getSessionAndProfile = async () => {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    setSession(session);
                    if (session) {
                        const { data: profile } = await supabaseClient.from('profiles').select('*, subscriptions(*)').eq('id', session.user.id).single();
                        setUserProfile(profile);
                    }
                    setLoading(false);
                };
                getSessionAndProfile();

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(async (_event, session) => {
                    setSession(session);
                    if (session) {
                         const { data: profile } = await supabaseClient.from('profiles').select('*, subscriptions(*)').eq('id', session.user.id).single();
                         setUserProfile(profile);
                    } else {
                        setUserProfile(null);
                    }
                });

                return () => subscription.unsubscribe();
            }, []);

            if (supabaseInitializationError) {
                return <div className="min-h-screen flex items-center justify-center text-red-400 p-4"><div className="glass-card p-8 rounded-xl max-w-lg text-center"><h1 className="text-2xl font-bold mb-4">Erro de Configuração</h1><p>{supabaseInitializationError}</p></div></div>;
            }

            if (loading) {
                return <div className="min-h-screen flex items-center justify-center"><p>A carregar...</p></div>
            }

            if (!session) {
                return <LoginPage onLogin={(user) => setSession({ user })} />;
            }
            
            if (userProfile && userProfile.role === 'admin') {
                return <AdminDashboard />;
            }
            
            if (userProfile) {
                return <ClientDashboard userProfile={userProfile} />;
            }

            return <div className="min-h-screen flex items-center justify-center"><p>A carregar perfil...</p></div>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
